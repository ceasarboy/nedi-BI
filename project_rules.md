# PB-BI 项目规则与经验总结

## ACP 敏捷开发流程

本项目采用 ACP（敏捷）开发方式，包含以下核心角色和流程：

### 1. 架构师职责
- 制定系统架构设计
- 汇总和确认需求分析
- 每次迭代时重新确认架构和需求是否变更
- 更新需求分析文档和架构设计文档

### 2. 项目经理职责
- 按照架构和需求制定开发计划
- 跟踪开发计划进度
- 如有更新需求，及时更新开发计划

### 3. 软件开发人员职责
- 前端使用 React 开发，保持编程风格一致
- 进行软件开发
- 如代码审查存在问题，修改并重新提交审查

### 4. 代码审查人员职责
- 对开发代码进行审查
- 反馈审查意见给开发人员
- 对整改后的代码进行重新审查

### 5. 软件测试人员职责
- 编制软件测试用例和测试大纲
- 对软件进行测试
- 反馈测试结果给软件开发人员
- 直到软件通过测试

### 6. ACP 推进专家职责
- 总结软件经验和教训
- 记录到 project_rules.md

---

## 迭代 1.1 经验总结

### 本次迭代完成的功能
1. ✅ 在数据流列表的"测试"按钮后添加"设置"按钮
2. ✅ 点击设置按钮后显示该数据流的所有字段列表
3. ✅ 支持配置字段属性（字段类型）
4. ✅ 支持选择是否使用该字段（启用/禁用）
5. ✅ 保存字段配置功能

### 经验教训

#### 1. 严格遵守ACP流程的重要性
**问题**：在本次迭代初期，没有先更新需求分析和架构设计文档就直接开始编码
**教训**：必须严格按照ACP流程执行，每次迭代都应该：
1. 架构师先确认并更新需求分析和架构设计
2. 项目经理更新开发计划
3. 开发人员进行开发
4. 代码审查人员进行审查
5. 测试人员更新测试大纲
6. ACP专家总结经验教训

#### 2. 数据库设计的灵活性
**经验**：在设计字段启用状态时，使用字符串存储（"true"/"false"）比布尔类型更简单，避免了类型转换的复杂性
**建议**：在前后端交互时，对于简单的布尔标志，可以考虑使用字符串格式

#### 3. 用户体验优化
**经验**：
- 添加"保存配置"按钮，让用户明确知道需要手动保存
- 在标题中显示当前配置的数据流名称，提供清晰的上下文
- 使用灰色的次要按钮样式区分"设置"按钮和其他操作按钮

#### 4. 代码质量
**经验**：
- 代码结构清晰，职责分离明确
- 错误处理完善，提供友好的提示信息
- 样式设计美观，用户体验良好

### 改进建议

1. **流程改进**：建立明确的迭代启动检查清单，确保每次迭代都按ACP流程执行
2. **文档改进**：在需求分析文档中添加用户故事，更清晰地描述用户需求
3. **测试改进**：在开发过程中同步编写单元测试，提高代码质量
4. **沟通改进**：在每次迭代开始前，先进行简短的团队沟通，确认需求和计划

---

## 迭代 2.13 经验总结（图表功能优化与第一阶段总结）

### 本次迭代完成的功能
1. ✅ 3D柱状图优化：透明效果、数据维度修复
2. ✅ 创建3D形貌图组件 - Surface3DChart
3. ✅ 创建联动图表组件 - LinkedChart
4. ✅ 创建LED晶圆分析图组件 - LEDWaferChart
5. ✅ 实现波长到RGB颜色转换算法
6. ✅ 数据看板图表高度加大（翻倍）
7. ✅ 第一阶段完成总结
8. ✅ 更新所有文档（需求分析、架构设计、开发计划）

### 经验教训

#### 1. 第一阶段完成的里程碑意义 ⭐重要
**经验**：
- 第一阶段从2026-02-14到2026-02-22，共8天
- 完成了5个核心模块：配置管理、数据获取、数据分析、数据可视化、操作介绍
- 实现了10+种图表类型
- 功能基本覆盖BI软件的核心需求
**里程碑**：
- 第一阶段是从0到1的过程，建立了完整的BI软件基础
- 为后续迭代（可部署版本、蒙特卡洛完善、可视化计算）打下了坚实基础

#### 2. 波长到RGB颜色转换的实现要点 ⭐重要
**经验**：
- 可见光波长范围380-780nm
- 分为8个区间进行线性插值
- 超出范围时显示灰色（#808080）
- 转换后需要归一化到0-255范围
- 使用toHex函数确保输出两位十六进制数

**实现的8个区间**：
1. 380-450nm: R从0到0, G从0到0, B从255到255（蓝色）
2. 450-500nm: R从0到0, G从0到255, B从255到0（青色）
3. 500-570nm: R从0到255, G从255到255, B从0到0（绿色）
4. 570-590nm: R从255到255, G从255到0, B从0到0（黄色）
5. 590-620nm: R从255到255, G从0到0, B从0到0（橙色）
6. 620-780nm: R从255到255, G从0到0, B从0到0（红色）

#### 3. ECharts 3D图表的数据结构要点
**经验**：
- 3D柱状图：数据格式 [[x, y, z], ...]，注意三个维度的顺序
- 3D形貌图：数据格式 [[z1, z2, ...], ...]，二维数组表示网格
- 透明效果：使用opacity配置，让多个柱子叠加时可以看到下方
- 视角控制：设置autoRotate提升用户体验

#### 4. 联动图表的实现要点
**经验**：
- 使用ECharts的updateAxisPointer事件实现联动
- 共享同一个dataset，确保数据一致性
- 折线图和饼图可以很好地配合展示
- 鼠标悬停时两个图表同步高亮，视觉效果好

#### 5. 代码审查的彻底性 ⭐重要
**经验**：
- 代码审查不仅要检查功能，还要检查代码质量
- 本次审查发现：Bar3DChart和Surface3DChart中有未使用的变量
- 及时清理未使用的变量，保持代码整洁
- 代码审查是质量保障的重要环节

#### 6. 用户反馈的快速响应
**经验**：
- 用户反馈"数据看板图表尺寸好像比较小"，立即响应并修复
- 将图表高度加大一倍，提升用户体验
- 用户体验优化是持续的过程

#### 7. 第一阶段待完善功能的记录
**经验**：
- 即使第一阶段完成，也要清楚记录待完善的功能
- 本次记录：
  - 蒙特卡洛分析模块：自定义模拟功能待开发
  - 可视化计算模块：尚未开展
- 为后续迭代明确方向

#### 8. 文档更新的同步性 ⭐重要
**经验**：
- 每次迭代都要同步更新三个文档：需求分析、架构设计、开发计划
- 文档版本号要保持同步递增
- 文档是项目的重要资产，要保持最新状态
- ACP流程要求先更新文档，再开始编码

### 改进建议（补充）

96. **版本管理改进**：建议初始化Git仓库，进行代码版本管理
97. **第一阶段回顾改进**：建议召开第一阶段回顾会议，总结经验教训
98. **部署准备改进**：提前规划部署方案，包括host配置、端口设置等
99. **功能优先级改进**：明确第二阶段功能的优先级排序
100. **用户测试改进**：第一阶段完成后，建议邀请用户进行测试，收集反馈

---

## 迭代 3.0 经验总结（可部署版本生成）

### 本次迭代完成的功能
1. ✅ 后端部署配置（host=0.0.0.0）
2. ✅ 前端构建优化（vite.config.js配置）
3. ✅ 创建启动脚本（start.bat、start-dev.bat、build.bat、start.sh）
4. ✅ 创建部署说明文档（DEPLOYMENT.md）
5. ✅ 创建项目说明文档（README.md）
6. ✅ 测试本地部署
7. ✅ 测试局域网访问
8. ✅ 代码审查和修复

### 经验教训

#### 1. 部署配置的关键要点 ⭐重要
**经验**：
- 后端必须绑定到 `0.0.0.0` 而不是 `127.0.0.1`，否则只能本机访问
- 前端 vite.config.js 需要配置 `server.host` 和 `preview.host` 为 `'0.0.0.0'`
- 前端构建后使用 `npm run preview` 启动预览服务

**配置示例**：
```javascript
// vite.config.js
server: {
  host: '0.0.0.0',
  port: 3000
},
preview: {
  host: '0.0.0.0',
  port: 3000
}
```

#### 2. 启动脚本的路径处理 ⭐重要
**问题**：启动脚本放在 scripts 目录下，路径引用需要正确处理
**解决**：
- Windows: 使用 `%~dp0` 获取脚本所在目录，然后用 `..` 获取项目根目录
- Linux/macOS: 使用 `$(dirname "${BASH_SOURCE[0]}")` 获取脚本目录

**正确示例**：
```batch
set PROJECT_DIR=%~dp0..
start "PB-BI Backend" cmd /k "cd /d %PROJECT_DIR% && venv\Scripts\activate && ..."
```

#### 3. 局域网访问的验证
**经验**：
- Vite 启动后会自动显示 Network 地址
- 例如：`http://192.168.1.6:3000/`
- 可以直接从其他电脑访问该地址
- 需要确保防火墙允许对应端口

#### 4. 部署文档的重要性
**经验**：
- DEPLOYMENT.md 应该包含完整的部署步骤
- 包括环境要求、安装步骤、启动命令、常见问题
- README.md 应该包含项目简介和快速开始指南
- 文档是用户的第一印象，要清晰明了

#### 5. 前端构建优化
**经验**：
- 使用 `vite build` 构建生产版本
- 输出目录默认为 `dist`
- 构建时会提示 chunk 大小警告，可以考虑代码分割优化
- 使用 `sourcemap: false` 减小构建体积

#### 6. Windows PowerShell 的命令语法
**问题**：PowerShell 不支持 `&&` 作为命令分隔符
**解决**：使用 `;` 代替 `&&`
```powershell
# 错误
cd f:\PB-BI\frontend && npm run build

# 正确
cd f:\PB-BI\frontend; npm run build
```

#### 7. 服务启动顺序
**经验**：
- 先启动后端服务，等待几秒后再启动前端
- 前端启动时会尝试连接后端 API
- 如果后端未启动，前端可能显示错误

#### 8. ACP流程的持续执行 ⭐重要
**经验**：
- 即使是部署任务，也要严格按照ACP流程执行
- 本次迭代严格执行了：
  1. 架构师：确认部署需求
  2. 项目经理：制定部署计划
  3. 开发人员：进行部署配置
  4. 代码审查人员：审查配置并修复问题
  5. ACP专家：总结经验教训
- 流程是质量的保障

### 改进建议（补充）

101. **Docker化改进**：建议创建 Dockerfile 和 docker-compose.yml，简化部署流程
102. **进程管理改进**：建议使用 pm2 或 supervisor 管理进程，支持自动重启
103. **Nginx反向代理改进**：生产环境建议使用 Nginx 作为反向代理
104. **环境变量改进**：建议使用 .env 文件管理环境变量
105. **日志管理改进**：建议添加日志收集和分析功能
106. **监控告警改进**：建议添加服务监控和告警功能
107. **HTTPS支持改进**：生产环境建议启用 HTTPS
108. **数据库备份改进**：建议添加数据库自动备份功能

---

## 版本历史

| 版本 | 日期 | 迭代 | 说明 |
|------|------|------|------|
| 1.0 | 2026-02-14 | 迭代 1.1 | 初始版本，记录迭代 1.1 的经验教训 |
| 2.13 | 2026-02-22 | 迭代 2.13 | 记录迭代 2.13 经验教训，第一阶段完成总结 |
| 3.0 | 2026-02-22 | 迭代 3.0 | 记录迭代 3.0 经验教训，可部署版本生成完成
