# PB-BI 需求分析文档

## 版本信息
- 版本: 2.8
- 创建日期: 2026-02-14
- 最后更新: 2026-02-22
- 状态: 可部署版本生成完成

## 1. 项目背景

PB-BI 是一个商业智能软件，主要用于连接明道云数据源，进行数据提取、处理、分析和可视化展示。

## 2. 业务需求

### 2.1 数据连接
- 支持配置明道云 API 连接
- 支持配置数据库连接

### 2.2 数据获取
- 从明道云读取工作表数据
- 支持字段选择
- 支持字段类型设置

### 2.3 数据处理
- 可视化字段数据运算
- 支持自定义 Python 计算模块
- 灵活的数据转换能力

### 2.4 数据可视化
- 多种图表类型展示
- 分析结果可视化

## 3. 功能需求

### 3.1 配置管理模块

#### 3.1.1 明道云 API 配置
- 功能描述: 配置明道云 API 访问参数
- 输入:
  - appkey: 应用密钥
  - sign: 签名密钥
  - 工作表 ID: 目标工作表标识
- 输出: 配置保存成功/失败状态
- 验收标准: 配置正确保存，能够成功连接明道云 API

#### 3.1.2 数据库配置
- 功能描述: 配置数据库连接参数
- 输入: 数据库连接信息（主机、端口、用户名、密码、数据库名）
- 输出: 连接测试结果
- 验收标准: 能够成功连接数据库

### 3.2 数据获取模块

#### 3.2.1 字段读取
- 功能描述: 读取明道云工作表的字段信息
- 输入: 工作表 ID
- 输出: 字段列表（包含字段名、字段类型）
- 验收标准: 正确获取所有字段及其类型

#### 3.2.2 字段类型设置
- 功能描述: 设置字段的数据类型
- 输入: 字段 ID、目标类型
- 输出: 设置确认
- 验收标准: 字段类型正确保存并生效

#### 3.2.3 字段启用设置
- 功能描述: 设置字段是否启用
- 输入: 字段 ID、启用状态
- 输出: 设置确认
- 验收标准: 字段启用状态正确保存并生效

#### 3.2.4 数据流设置按钮
- 功能描述: 在数据流列表中添加设置按钮，点击后显示字段配置界面
- 输入: 点击设置按钮
- 输出: 显示该数据流的所有字段列表
- 验收标准: 正确显示字段列表，支持配置字段属性

#### 3.2.5 数据读取
- 功能描述: 根据选择的字段读取数据
- 输入: 选中的字段列表
- 输出: 数据集
- 验收标准: 准确读取指定字段的数据

#### 3.2.6 数据同步和展示
- 功能描述: 将明道云的数据按数据设置读入，展示在数据页面
- 输入: 选择数据流，点击同步数据
- 输出: 显示数据流的所有数据（仅显示启用的字段）
- 验收标准: 
  - 只显示在数据设置中启用的字段
  - 数据以表格形式展示
  - 支持分页查看
  - 数据格式正确显示

#### 3.2.7 数据存储到本地数据库
- 功能描述: 将从明道云加载的数据保存到本地数据库，后续从本地数据库读取
- 输入: 
  1. 点击"加载数据"按钮从明道云读取数据
  2. 点击"保存"按钮，弹出对话框
  3. 输入数据快照名称（默认：工作表ID）
  4. 确认保存
- 输出: 数据保存到本地数据库，显示保存的快照列表
- 验收标准:
  - 加载数据后显示"保存"按钮
  - 点击"保存"按钮弹出命名对话框
  - 默认名称为明道云工作表ID
  - 数据成功保存到本地数据库
  - 可以查看和选择已保存的数据快照
  - 从本地数据库读取数据展示

#### 3.2.8 数据快照管理
- 功能描述: 管理已保存的数据快照
- 输入: 选择数据快照
- 输出: 显示该快照的数据
- 验收标准:
  - 显示已保存的数据快照列表
  - 可以选择不同的快照查看
  - 可以删除数据快照

#### 3.2.9 数据页面重构
- 功能描述: 重构数据页面的导航和布局
- 输入: 
  - 点击"导入数据"按钮（原"选择数据流"）
  - 点击"已有数据"按钮（原"数据快照"）
- 输出:
  - "导入数据"页面：从明道云加载数据并保存
  - "已有数据"页面：显示数据流列表和数据明细
- 验收标准:
  - "选择数据流"改为"导入数据"
  - "数据快照"改为"已有数据"
  - 已有数据页面显示数据流列表（分页）
  - 选择数据流后显示该数据流的详细数据列表（分页）
  - 所有列表支持分页显示

#### 3.2.10 导入本地数据
- 功能描述: 支持从本地导入CSV和Excel格式的数据文件
- 输入:
  - 在"导入数据"页面点击"导入本地"按钮
  - 选择CSV或Excel文件
  - 输入数据快照名称
- 输出:
  - 解析并显示导入的数据
  - 保存为数据快照
- 验收标准:
  - 在数据流列表后面添加"导入本地"按钮
  - 支持选择CSV文件（.csv）
  - 支持选择Excel文件（.xlsx, .xls）
  - 解析文件并显示数据预览
  - 支持保存为数据快照
  - 数据格式正确显示

### 3.3 数据分析模块

#### 3.3.1 页面重命名
- 功能描述: 将"计算"页面重命名为"分析"页面
- 输入: 无
- 输出: 导航栏显示"分析"页面
- 验收标准: 导航栏显示"分析"而非"计算"

#### 3.3.2 多表聚合功能
- 功能描述: 支持选择多个数据快照进行聚合分析
- 输入:
  - 选择多个数据快照
  - 选择聚合方式（UNION ALL、UNION、JOIN、LEFT JOIN、RIGHT JOIN、FULL JOIN）
  - 配置关联字段（JOIN方式时需要）
- 输出: 聚合后的数据结果
- 验收标准:
  - 支持选择多个数据快照
  - 支持多种聚合方式
  - JOIN方式支持配置关联字段
  - 聚合结果正确显示

#### 3.3.3 数据转换功能
- 功能描述: 对数据进行转换处理
- 输入: 数据转换规则
- 输出: 转换后的数据
- 验收标准: 数据转换功能正常

#### 3.3.4 字段筛选功能
- 功能描述: 选择数据快照，筛选字段形成新的数据源
- 输入:
  - 选择一个数据快照
  - 选择要保留的字段
- 输出:
  - 显示筛选后的数据预览
  - 支持保存为新的数据快照
- 验收标准:
  - 支持选择单个数据快照
  - 显示该快照的所有字段
  - 支持勾选/取消勾选字段
  - 实时显示筛选后的数据
  - 支持保存为新的数据快照

#### 3.3.5 数据统计功能
- 功能描述: 对数据源进行统计分析，形成统计表单
- 输入:
  - 选择一个数据快照
  - 执行统计
- 输出:
  - 显示统计结果（计数、求和、平均值、最小值、最大值等）
  - 统计结果以表格形式展示
  - 支持保存为新的数据快照
- 验收标准:
  - 支持选择单个数据快照
  - 自动识别数值型字段进行统计
  - 统计指标包括：计数、求和、平均值、最小值、最大值
  - 统计结果以表格形式清晰展示
  - 支持保存为新的数据快照

#### 3.3.6 高级统计分析功能
- 功能描述: 使用 statsmodels 和 scikit-learn 进行高级统计分析
- 输入:
  - 选择一个数据快照
  - 选择要分析的字段
  - 选择分析类型（统计描述、分布拟合、回归分析）
  - 分布拟合：设置是否去掉空数据（默认勾选）
  - 回归分析：多项式回归时设置多项式阶数（degree，默认2）
- 输出:
  - 统计描述结果（均值、标准差、偏度、峰度、分位数等）
  - 分布拟合结果（正态分布、指数分布、泊松分布等拟合度检验）
  - 回归分析结果（线性回归、岭回归、Lasso回归、多项式回归、回归系数、R²、P值、均方误差MSE等）
  - 可视化图表（分布拟合直方图+拟合曲线、回归拟合图）
  - 回归拟合公式（所有系数保留4位小数）
  - 支持保存分析结果为新快照
- 验收标准:
  - 集成 statsmodels 库进行统计分析
  - 集成 scikit-learn 库进行机器学习分析
  - 支持多种统计检验（正态性检验、方差分析等）
  - 支持多种分布拟合和检验
  - 分布拟合结果下方显示拟合分布图（直方图+拟合曲线）
  - 分布拟合支持去掉空数据选项（默认勾选）
  - 支持线性回归、岭回归、Lasso回归、多项式回归
  - 多项式回归支持设置多项式阶数（1-10）
  - 回归分析显示拟合公式（所有系数保留4位小数）
  - 回归分析显示拟合图（蓝色散点表示实际数据，红色曲线表示拟合结果）
  - 回归模型评估包含均方误差（MSE）
  - 结果可视化展示
  - 支持保存分析结果

#### 3.3.9 蒙特卡洛分析功能（独立页面）
- 功能描述: 提供蒙特卡洛模拟功能，支持经典案例和自定义模拟
- 参考: https://cloud.tencent.com/developer/article/1971582
- 输入:
  - 选择模拟类型（经典案例、自定义模拟）
  - 经典案例1：计算圆周率 π
    - 设置模拟点数（默认10000）
  - 经典案例2：定积分计算
    - 设置积分区间（默认[0, 1]）
    - 设置积分函数（默认x²）
    - 设置模拟点数（默认10000）
  - 经典案例3：排队问题
    - 设置人数（默认20）
    - 设置到达时间分布（默认0-10分钟均匀分布）
    - 设置服务时间分布（默认1-3分钟均匀分布）
    - 设置模拟次数（默认1000）
  - 自定义模拟：
    - 选择输入变量（来自数据快照）
    - 设置每个变量的分布类型和参数
    - 设置计算公式
    - 设置模拟次数
- 输出:
  - 经典案例1（圆周率）：
    - 估计的π值
    - 模拟点可视化（正方形内的圆，点的分布）
    - 误差分析
  - 经典案例2（定积分）：
    - 估计的积分值
    - 模拟点可视化（函数曲线下的面积）
    - 误差分析
  - 经典案例3（排队问题）：
    - 等待时间统计（均值、标准差、分布）
    - 服务时间统计
    - 空闲时间统计
    - 可视化图表
  - 自定义模拟：
    - 结果统计（均值、标准差、中位数、分位数）
    - 置信区间（95%、99%）
    - 结果分布直方图
    - 敏感性分析
- 验收标准:
  - 蒙特卡洛分析有独立的页面，不在高级统计中
  - 支持3个经典案例：计算圆周率、定积分计算、排队问题
  - 每个经典案例有详细的参数设置
  - 每个案例有可视化展示
  - 支持自定义模拟功能
  - 参考腾讯云文章的实现方法
  - 结果准确，可视化清晰

#### 3.3.7 相关性分析功能（独立页面）
- 功能描述: 支持选择多个数据流的字段进行相关性分析，探索变量之间的线性关系
- 输入:
  - 选择多个数据快照（可以来自不同数据流）
  - 从每个快照中选择1个或多个数值型字段
  - 选择相关系数类型（皮尔逊Pearson、斯皮尔曼Spearman、肯德尔Kendall）
  - 设置相关性阈值（筛选高相关字段，默认0.7）
- 输出:
  - 相关系数矩阵（显示所有选中字段两两之间的相关系数）
  - 相关性热力图可视化（蓝色表示负相关，红色表示正相关）
  - 高相关对列表（显示相关系数绝对值 > 阈值的变量对）
  - 支持筛选高相关性字段（只显示相关系数绝对值 > 阈值的字段）
  - 支持保存分析结果为新快照
- 验收标准:
  - 相关性分析有独立的页面，不在高级统计中
  - 支持选择多个数据快照
  - 支持从每个快照选择多个字段
  - 支持3种相关系数类型：皮尔逊、斯皮尔曼、肯德尔
  - 显示完整的相关系数矩阵
  - 热力图正确展示相关关系
  - 自动识别并高亮显示高相关变量对
  - 支持设置相关性阈值，筛选高相关字段
  - 支持保存分析结果

#### 3.3.8 相关性探索功能
- 功能描述: 在相关性分析页面中增加相关性探索标签页，支持批量探索多个字段的两两相关性
- 输入:
  - 选择多个数据快照（可以来自不同数据流）
  - 从每个快照中选择多个数值型字段
  - 选择相关系数类型（皮尔逊Pearson、斯皮尔曼Spearman、肯德尔Kendall）
  - 设置相关性阈值（默认为0.8）
- 输出:
  - 将所有选中字段两两组成一组进行相关性分析
  - 提取相关性强的几组数据（相关系数绝对值 > 阈值）
  - 按相关系数绝对值从高到低排序显示
  - 显示每对字段的相关系数、所属快照、相关类型（强正相关/强负相关）
- 验收标准:
  - 相关性分析页面有两个标签页：相关性分析、相关性探索
  - 两个标签页可以自由切换
  - 相关性探索标签页支持选择多个数据流的多个字段
  - 自动将所有选中字段两两组合进行相关性分析
  - 只显示相关系数绝对值 > 阈值的字段对
  - 阈值可以由用户设置，默认为0.8
  - 结果按相关系数绝对值从高到低排序
  - 清晰显示每对字段的所属快照和字段名

#### 3.3.8 自定义计算模块
- 功能描述: 使用 Python 代码编写自定义计算逻辑
- 输入: Python 代码
- 输出: 计算结果
- 验收标准: 代码安全执行，结果正确

### 3.4 数据可视化模块

#### 3.4.1 丰富图表类型
- 功能描述: 集成多个图表库，提供丰富的图表类型
- 输入: 数据集、图表类型
- 输出: 可视化图表
- 验收标准:
  - 集成 ECharts 图表库
  - 每个图表都标明来源（如：折线图-ECharts）
  - 图表正确渲染，数据展示准确

#### 3.4.2 ECharts 图表支持
- 功能描述: 提供多种 ECharts 图表类型
- 支持的图表类型:
  - 折线图-ECharts
  - 柱状图-ECharts
  - 饼图-ECharts
  - 散点图-ECharts
  - 雷达图-ECharts
  - 漏斗图-ECharts
  - 仪表盘-ECharts
  - 热力图-ECharts
  - 3D柱状图-ECharts
  - 堆叠折线图-ECharts
  - 堆叠柱状图-ECharts
  - 多Y轴图-ECharts
  - 3D形貌图-ECharts
  - 联动图表-ECharts
  - LED晶圆分析图-ECharts
- 验收标准: 所有 ECharts 图表都能正常渲染

#### 3.4.3 图表功能优化
- 功能描述: 优化现有图表功能，提升用户体验
- 功能点:
  - 3D柱状图透明效果和数据维度正确处理
  - 3D形貌图数据结构优化
  - 数据看板图表高度加大（翻倍）
  - LED晶圆分析图支持波长到RGB颜色转换
  - LED晶圆分析图tooltip显示波长信息
- 验收标准:
  - 图表功能完善，用户体验良好
  - LED晶圆分析图正确显示波长对应颜色
  - tooltip显示完整信息

#### 3.4.4 波长到RGB颜色转换
- 功能描述: 将光的波长值（380-780nm）转换为RGB颜色
- 输入:
  - 波长值（nm）
- 输出:
  - RGB颜色（十六进制格式）
- 验收标准:
  - 380-450nm: 紫色到蓝色
  - 450-500nm: 蓝色到青色
  - 500-570nm: 青色到绿色
  - 570-590nm: 绿色到黄色
  - 590-620nm: 黄色到橙色
  - 620-780nm: 橙色到红色
  - 超出范围时显示灰色

#### 3.4.4 图表设置完善
- 功能描述: 为每个图表提供详细的设置配置
- 输入: 图表配置参数
- 输出: 更新后的图表
- 验收标准:
  - 每个图表都有完善的设置面板
  - 支持配置图表标题
  - 支持配置图例
  - 支持配置坐标轴
  - 支持配置颜色主题
  - 支持配置提示框
  - 设置变更后图表实时更新

#### 3.4.5 图表设置优化
- 功能描述: 优化图表设置体验
- 输入: 无
- 输出: 优化后的设置界面
- 验收标准:
  - 设置界面布局合理
  - 操作流程清晰
  - 提供预设样式快速选择
  - 支持保存和加载图表配置

### 3.5 操作介绍模块

#### 3.5.1 操作介绍页面
- 功能描述: 提供软件的整体布局和操作指导
- 输入: 无
- 输出: 操作介绍页面
- 验收标准:
  - 显示软件的整体布局说明
  - 展示各个页面的功能介绍
  - 提供详细的操作指导
  - 界面美观，易于阅读
  - 支持快速跳转到各个功能页面

## 4. 非功能需求

### 4.1 性能需求
- 数据读取响应时间 < 5 秒
- 图表渲染时间 < 3 秒

### 4.2 安全需求
- API 密钥加密存储
- 自定义 Python 代码执行环境隔离

### 4.3 易用性需求
- 界面简洁直观
- 操作流程清晰

### 4.4 可维护性需求
- 代码结构清晰
- 注释完整

## 5. 约束条件

- 前端技术栈: React
- 后端技术栈: Python
- 数据源: 明道云 API

---

## 第一阶段总结

### 已完成功能清单
1. ✅ 配置管理模块
   - 明道云 API 配置
   - 数据流管理（增删改查）
   - 字段配置（字段类型、启用/禁用）
   
2. ✅ 数据获取模块
   - 从明道云读取数据
   - 导入本地数据（CSV、Excel）
   - 数据快照管理
   - 数据页面展示

3. ✅ 数据分析模块
   - 多表聚合（UNION ALL、UNION、JOIN等）
   - 字段筛选
   - 数据统计
   - 高级统计分析（统计描述、分布拟合、回归分析）
   - 相关性分析（独立页面，支持多数据流）
   - 相关性探索
   - 蒙特卡洛分析（独立页面，支持经典案例）

4. ✅ 数据可视化模块
   - 10+种 ECharts 图表类型
   - 3D图表支持
   - LED晶圆分析图
   - 数据看板
   - 图表设置

5. ✅ 操作介绍模块
   - 操作指南页面
   - 快速跳转功能

### 待完善功能
1. ⚠️ 蒙特卡洛分析模块：自定义模拟功能待开发
2. ⚠️ 可视化计算模块：尚未开展

---

**变更记录**
| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| 1.0 | 2026-02-14 | 架构师 | 初始版本创建 |
| 1.1 | 2026-02-14 | 架构师 | 添加字段启用设置和数据流设置按钮需求 |
| 1.2 | 2026-02-15 | 架构师 | 添加数据同步和展示需求 |
| 1.3 | 2026-02-15 | 架构师 | 添加数据存储到本地数据库和快照管理需求 |
| 1.4 | 2026-02-15 | 架构师 | 添加数据页面重构需求（导入数据/已有数据，分页） |
| 1.5 | 2026-02-19 | 架构师 | 添加数据分析模块（多表聚合、数据转换）、丰富图表类型（ECharts + DataV）、完善图表设置需求 |
| 1.6 | 2026-02-19 | 架构师 | 取消DataV图表库，新增4个ECharts图表（3D柱状图、堆叠折线图、堆叠柱状图、多Y轴图） |
| 1.7 | 2026-02-19 | 架构师 | 新增导入本地数据功能（CSV和Excel格式） |
| 1.8 | 2026-02-19 | 架构师 | 新增字段筛选功能和数据统计功能 |
| 1.9 | 2026-02-19 | 架构师 | 新增操作介绍页面 |
| 2.0 | 2026-02-20 | 架构师 | 新增高级统计分析功能（统计描述、分布拟合、回归分析） |
| 2.1 | 2026-02-20 | 架构师 | 分布拟合分析结果添加拟合分布图（直方图+拟合曲线） |
| 2.2 | 2026-02-20 | 架构师 | 分布拟合添加去掉空数据选项，回归分析添加拟合公式和拟合图，多项式回归支持设置degree |
| 2.3 | 2026-02-21 | 架构师 | 回归模型评估增加均方误差（MSE），新增相关分析和蒙特卡洛分析功能 |
| 2.4 | 2026-02-21 | 架构师 | 相关性分析从高级统计中移出，独立成页，支持多数据流字段分析 |
| 2.5 | 2026-02-21 | 架构师 | 相关性分析添加筛选高相关字段功能，新增相关性探索标签页 |
| 2.6 | 2026-02-21 | 架构师 | 蒙特卡洛分析从高级统计中移出，独立成页，支持经典案例（圆周率、定积分、排队问题）和自定义模拟 |
| 2.7 | 2026-02-22 | 架构师 | 新增图表功能优化（3D图表、LED晶圆图、波长到RGB转换），第一阶段完成总结
