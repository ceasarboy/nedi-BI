# PB-BI 架构设计文档

## 版本信息
- 版本: 3.6
- 创建日期: 2026-02-14
- 最后更新: 2026-02-22
- 状态: 用户认证功能设计

## 1. 系统概述

PB-BI 采用前后端分离架构，前端使用 React 负责用户交互和数据可视化，后端使用 Python 负责数据处理和业务逻辑。

## 2. 技术架构

### 2.1 技术栈选择

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端框架 | React | 用户界面框架 |
| 前端图表库 | ECharts + echarts-gl | 数据可视化（包含3D图表支持） |
| API 网关层 | FastAPI | Python Web 框架，负责 API 网关和用户交互 |
| 数据服务层 | Spring Boot | Java Web 框架，负责 Calcite + SeaTunnel 集成 |
| SQL 查询引擎 | Apache Calcite | 动态 SQL 查询和 SQL 解析 |
| 数据集成 | Apache SeaTunnel | 数据同步和转换 |
| 代码执行 | Python 沙箱 / JVM 沙箱 | 代码安全执行 |
| 数据库 | SQLite (开发) / PostgreSQL (生产) | 配置存储 |
| 密码加密 | bcrypt | 密码安全存储 |
| 会话管理 | FastAPI Session | 用户会话管理 |

### 2.1.1 混合架构方案（方案 1：HTTP API 桥接）

#### 架构概述
采用 FastAPI + Spring Boot 的混合架构，通过 HTTP/REST API 进行通信：
- **FastAPI 服务**：作为 API 网关，处理前端请求、配置管理、基础数据查询
- **Spring Boot 服务**：作为数据服务层，集成 Apache Calcite 和 Apache SeaTunnel，提供高级 SQL 查询和数据同步功能
- **通信方式**：FastAPI 通过 HTTP/REST 调用 Spring Boot 的 API

#### 优势
1. 渐进式升级：保留现有 FastAPI 代码，逐步迁移功能
2. 技术栈解耦：FastAPI 和 Spring Boot 独立开发和部署
3. 风险可控：可以先在 Spring Boot 中验证 Calcite + SeaTunnel，再决定是否全面迁移
4. 团队友好：Python 和 Java 团队可以并行工作

### 2.2 系统架构图（混合架构）

```
┌─────────────────────────────────────────────────────────┐
│                        前端 (React)                       │
├──────────────────┬──────────────────┬───────────────────┤
│  配置管理模块    │  数据分析模块    │  可视化模块       │
│  用户认证模块    │                  │                   │
└────────┬─────────┴────────┬─────────┴─────────┬─────────┘
         │                   │                   │
         └───────────────────┼───────────────────┘
                             │
                    HTTP/REST API
                             │
         ┌───────────────────▼───────────────────┐
         │         FastAPI (API 网关层)           │
         ├──────────────────┬───────────────────┤
         │  配置管理 API    │  数据查询 API      │
         │  (现有功能)      │  (桥接调用)        │
         │  用户认证 API    │                   │
         └────────┬─────────┴─────────┬─────────┘
                  │                   │
         ┌────────▼─────────┐         │
         │  配置数据库      │         │
         │  (SQLite)        │         │
         └──────────────────┘         │
                                      │
                           HTTP/REST API (内部)
                                      │
         ┌────────────────────────────▼────────────────────────────┐
         │              Spring Boot (数据服务层)                     │
         ├──────────────────┬──────────────────┬───────────────────┤
         │  Calcite 服务    │  SeaTunnel 服务   │  数据同步服务     │
         │  (SQL 查询)      │  (数据集成)       │  (定时任务)       │
         └────────┬─────────┴────────┬─────────┴─────────┬─────────┘
                  │                   │                   │
         ┌────────▼─────────┬────────▼─────────┬─────────▼─────────┐
         │ Apache Calcite    │ Apache SeaTunnel  │  明道云 API       │
         │  (SQL 查询引擎)   │  (数据同步引擎)   │                   │
         └──────────────────┴──────────────────┴───────────────────┘
```

### 2.3 服务间 API 设计

#### FastAPI → Spring Boot 桥接 API

| API 端点 | 方法 | 说明 |
|----------|------|------|
| `/internal/calcite/query` | POST | 执行 Calcite SQL 查询 |
| `/internal/seatunnel/sync` | POST | 触发 SeaTunnel 数据同步 |
| `/internal/seatunnel/status` | GET | 查询同步任务状态 |

#### 请求/响应格式

**Calcite 查询请求**
```json
{
  "sql": "SELECT * FROM snapshot_table WHERE id > 100",
  "dataflow_id": 1
}
```

**SeaTunnel 同步请求**
```json
{
  "dataflow_id": 1,
  "sync_type": "full"  // full 或 incremental
}
```

## 3. 模块架构

### 3.1 前端模块架构

```
src/
├── components/
│   ├── ConfigForm/          # 配置表单组件
│   ├── FieldSelector/       # 字段选择组件
│   ├── Calculator/          # 计算器组件
│   ├── CodeEditor/          # 代码编辑器组件
│   ├── ChartViewer/         # 图表查看组件
│   ├── AggregatePanel/      # 多表聚合组件
│   ├── ChartSettings/       # 图表设置组件
│   └── Auth/                # 用户认证组件
│       ├── LoginForm.jsx    # 登录表单
│       ├── RegisterForm.jsx # 注册表单
│       └── UserInfo.jsx     # 用户信息展示
├── pages/
│   ├── LoginPage.jsx        # 登录页面
│   ├── ConfigPage/          # 配置页面
│   ├── DataPage/            # 数据页面
│   ├── AnalysisPage/        # 分析页面（原计算页面）
│   ├── VisualPage/          # 可视化页面
│   └── GuidePage/           # 操作介绍页面
├── services/
│   ├── api.js               # API 调用封装
│   ├── auth.js              # 认证服务
│   └── config.js            # 配置管理
├── charts/
│   └── echarts/             # ECharts 图表组件
│       ├── LineChart.jsx    # 折线图-ECharts
│       ├── BarChart.jsx     # 柱状图-ECharts
│       ├── PieChart.jsx     # 饼图-ECharts
│       ├── ScatterChart.jsx # 散点图-ECharts
│       ├── RadarChart.jsx   # 雷达图-ECharts
│       ├── FunnelChart.jsx  # 漏斗图-ECharts
│       ├── GaugeChart.jsx   # 仪表盘-ECharts
│       ├── HeatMap.jsx      # 热力图-ECharts
│       ├── Bar3DChart.jsx   # 3D柱状图-ECharts
│       ├── StackedLineChart.jsx # 堆叠折线图-ECharts
│       ├── StackedBarChart.jsx  # 堆叠柱状图-ECharts
│       ├── MultipleYAxisChart.jsx # 多Y轴图-ECharts
│       ├── Surface3DChart.jsx    # 3D形貌图-ECharts
│       ├── LinkedChart.jsx        # 联动图表-ECharts
│       └── LEDWaferChart.jsx      # LED晶圆分析图-ECharts
├── context/
│   └── AuthContext.jsx      # 认证上下文
├── types/
│   └── index.js             # 类型定义
└── App.jsx
```

### 3.2 后端模块架构（混合架构）

#### FastAPI 服务（API 网关层）
```
src/
├── api/
│   ├── __init__.py
│   ├── config.py            # 配置管理接口（现有）
│   ├── data.py              # 数据处理接口（现有）
│   ├── analysis.py          # 数据分析接口
│   ├── visual.py            # 可视化接口
│   ├── auth.py              # 用户认证接口（新增）
│   └── internal.py          # 内部桥接 API（调用 Spring Boot）
├── core/
│   ├── __init__.py
│   ├── config.py            # 配置管理
│   ├── database.py          # 数据库连接
│   ├── security.py          # 安全工具（密码加密、会话管理）
│   └── spring_boot_client.py # Spring Boot API 客户端
├── services/
│   ├── __init__.py
│   ├── mingdao.py           # 明道云 API 服务
│   ├── analysis.py          # 数据分析服务
│   ├── auth.py              # 用户认证服务（新增）
│   └── bridge.py            # 桥接服务
├── models/
│   ├── __init__.py
│   ├── config.py            # 数据模型
│   └── user.py              # 用户模型（新增）
└── main.py                   # FastAPI 应用入口
```

#### Spring Boot 服务（数据服务层）
```
spring-boot-service/
├── src/main/java/com/pbbi/dataservice/
│   ├── controller/
│   │   ├── CalciteController.java    # Calcite 查询 API
│   │   └── SeaTunnelController.java  # SeaTunnel 同步 API
│   ├── service/
│   │   ├── CalciteService.java       # Calcite 查询服务
│   │   └── SeaTunnelService.java     # SeaTunnel 同步服务
│   ├── calcite/
│   │   ├── CalciteSchema.java
│   │   ├── MingDaoTable.java
│   │   └── SnapshotTable.java
│   ├── seatunnel/
│   │   ├── SeaTunnelJobManager.java
│   │   └── SyncJobConfig.java
│   └── DataServiceApplication.java
├── src/main/resources/
│   ├── application.yml
│   └── seatunnel/
└── pom.xml
```

## 4. 核心模块设计

### 4.0 Apache Calcite 集成设计

#### 功能说明
- 提供统一的 SQL 查询接口
- 支持多数据源查询（明道云、本地数据库、快照数据）
- 动态 SQL 解析和优化
- 自定义函数支持

#### 架构设计
```
CalciteSchema
├── MingDaoTable  (明道云数据源)
├── SnapshotTable (快照数据源)
└── LocalTable    (本地数据库表)
```

#### 使用场景
- 用户编写 SQL 查询数据
- 跨数据源联合查询
- 数据聚合和计算

### 4.1 Apache SeaTunnel 集成设计

#### 功能说明
- 明道云数据到本地数据库的同步
- 增量数据同步
- 数据转换和清洗
- 定时任务调度

#### 同步流程
```
明道云 API → SeaTunnel Source → 数据转换 → SeaTunnel Sink → 本地数据库
```

#### 配置示例
```yaml
env {
  execution.parallelism = 1
}

source {
  Http {
    url = "明道云API地址"
    method = "GET"
    headers {
      HAP-Appkey = "${appkey}"
      HAP-Sign = "${sign}"
    }
  }
}

transform {
  Sql {
    query = "SELECT * FROM source"
  }
}

sink {
  Jdbc {
    url = "jdbc:sqlite:config/pb_bi.db"
    table = "data_snapshots"
  }
}
```

### 4.2 用户认证模块（新增）

#### 功能
- 用户注册（用户名、密码）
- 用户登录（用户名、密码验证）
- 内置admin用户（系统初始化时自动创建）
- 会话管理（登录状态保持）
- 用户登出
- 权限控制（admin可以查看所有数据，普通用户只能查看自己的数据）

#### 用户角色
| 角色 | 说明 | 权限 |
|------|------|------|
| admin | 超级管理员 | 可以查看所有用户的数据、数据流、快照、看板 |
| user | 普通用户 | 只能查看和操作自己创建的数据、数据流、快照、看板 |

#### 接口设计
```
POST   /api/auth/register         # 用户注册
POST   /api/auth/login            # 用户登录
POST   /api/auth/logout           # 用户登出
GET    /api/auth/me               # 获取当前用户信息
```

#### 注册请求
```json
{
  "username": "testuser",
  "password": "password123",
  "confirm_password": "password123"
}
```

#### 登录请求
```json
{
  "username": "testuser",
  "password": "password123"
}
```

#### 认证响应
```json
{
  "success": true,
  "user": {
    "id": 1,
    "username": "testuser",
    "role": "user"
  }
}
```

#### 前端路由保护
- 未登录用户访问任何页面时自动跳转到登录页
- 登录成功后跳转到首页（配置页面）
- 导航栏显示当前用户信息和登出按钮

### 4.3 配置管理模块

#### 功能
- 明道云 API 配置（appkey, sign, 工作表 ID）
- 数据库配置
- 配置持久化存储
- 数据流管理（增删改查，关联用户）
- 数据流连接测试
- 字段配置管理（字段启用/禁用、字段类型设置）

#### 接口设计
```
GET    /api/dataflows              # 获取当前用户的数据流（admin获取所有）
POST   /api/dataflows              # 创建数据流（关联当前用户）
PUT    /api/dataflows/{id}         # 更新数据流（仅自己或admin）
DELETE /api/dataflows/{id}         # 删除数据流（仅自己或admin）
POST   /api/dataflows/{id}/test    # 测试连接
GET    /api/dataflows/{id}/fields  # 获取字段列表
POST   /api/dataflows/{id}/fields  # 保存字段配置
```

### 4.4 数据获取模块

#### 功能
- 读取字段列表
- 设置字段类型
- 读取数据

#### 接口设计
```
GET    /api/data/{dataflow_id}/fields  # 获取字段列表（仅启用的）
POST   /api/data/query                   # 查询数据
```

#### 功能补充
- 按数据设置读取数据（仅启用的字段）
- 数据展示和分页
- 数据格式转换和显示
- 导入本地CSV和Excel文件
- 解析CSV和Excel数据

#### 接口设计补充
```
POST   /api/data/import/local          # 导入本地CSV/Excel文件（关联当前用户）
```

### 4.5 数据快照管理（权限控制）

#### 功能
- 数据快照列表（按用户过滤）
- 数据快照详情
- 数据快照删除

#### 权限规则
- admin用户：可以查看和删除所有数据快照
- 普通用户：只能查看和删除自己创建的数据快照

#### 接口设计
```
GET    /api/data/snapshots              # 获取数据快照列表（按用户权限过滤）
GET    /api/data/snapshots/{id}         # 获取数据快照详情（权限检查）
DELETE /api/data/snapshots/{id}         # 删除数据快照（权限检查）
POST   /api/data/snapshots              # 创建数据快照（关联当前用户）
```

### 4.6 看板管理（权限控制）

#### 功能
- 看板列表（按用户过滤）
- 看板详情
- 看板创建、更新、删除

#### 权限规则
- admin用户：可以查看和操作所有看板
- 普通用户：只能查看和操作自己创建的看板

#### 接口设计
```
GET    /api/dashboards              # 获取看板列表（按用户权限过滤）
GET    /api/dashboards/{id}         # 获取看板详情（权限检查）
POST   /api/dashboards              # 创建看板（关联当前用户）
PUT    /api/dashboards/{id}         # 更新看板（权限检查）
DELETE /api/dashboards/{id}         # 删除看板（权限检查）
```

### 4.7 数据分析模块

#### 功能
- 多表聚合（UNION ALL、UNION、JOIN、LEFT JOIN、RIGHT JOIN、FULL JOIN）
- 字段筛选（选择字段形成新数据源）
- 数据统计（计数、求和、平均值、最小值、最大值）
- 数据转换
- 自定义 Python 代码执行

#### 权限规则
- admin用户：可以选择所有数据快照
- 普通用户：只能选择自己创建的数据快照

#### 接口设计
```
POST   /api/analysis/aggregate    # 多表聚合（权限检查）
POST   /api/analysis/transform    # 数据转换
POST   /api/analysis/custom       # 自定义代码计算
```

#### 字段筛选功能设计
- 前端选择单个数据快照
- 显示该快照的所有字段列表
- 支持勾选/取消勾选字段
- 实时预览筛选后的数据
- 支持保存为新的数据快照

#### 数据统计功能设计
- 前端选择单个数据快照
- 自动识别数值型字段
- 计算统计指标：计数、求和、平均值、最小值、最大值
- 统计结果以表格形式展示
- 支持保存为新的数据快照

### 4.8 数据可视化模块

#### 功能
- 图表数据准备
- 支持多种图表类型（ECharts）
- 每个图表标明来源（如：折线图-ECharts）
- 完善的图表设置配置
- 图表设置优化

#### 接口设计
```
POST   /api/visual/chart       # 生成图表数据
```

### 4.9 操作介绍模块

#### 功能
- 软件整体布局说明
- 各个页面功能介绍
- 详细操作指导
- 快速跳转功能

#### 前端页面设计
- 页面结构：
  - 顶部：软件整体介绍
  - 中间：各功能模块卡片（配置管理、数据获取、数据分析、数据可视化）
  - 每个卡片包含：模块名称、功能描述、操作步骤、快速跳转按钮
- 交互设计：
  - 点击快速跳转按钮可直接跳转到对应页面
  - 卡片支持展开/收起详细内容
  - 使用图标和颜色区分不同功能模块

### 4.10 高级统计分析模块

#### 功能
- 统计描述分析（均值、标准差、偏度、峰度、分位数等）
- 分布拟合（正态分布、指数分布、泊松分布等）
- 分布检验（K-S检验、Shapiro-Wilk检验等）
- 回归分析（线性回归、多元回归）
- 结果可视化（分布图、QQ图、回归线图、残差图）
- 分布拟合分布图（直方图+拟合曲线）

#### 技术栈
- **statsmodels**: 统计建模和计量经济学分析
  - 描述统计
  - 假设检验
  - 回归分析
  - 时间序列分析
- **scikit-learn**: 机器学习库
  - 线性回归
  - 岭回归
  - Lasso回归
  - 多项式回归
- **scipy**: 科学计算
  - 分布拟合
  - 统计检验

#### 接口设计
```
POST   /api/analysis/statistical    # 统计描述分析
POST   /api/analysis/distribution   # 分布拟合分析
POST   /api/analysis/regression     # 回归分析
POST   /api/analysis/correlation    # 相关分析
POST   /api/analysis/montecarlo     # 蒙特卡洛分析
```

#### 分析类型说明

**1. 统计描述分析**
- 样本量、均值、中位数、众数
- 标准差、方差、极差
- 偏度、峰度
- 四分位数、百分位数
- 置信区间

**2. 分布拟合分析**
- 正态分布拟合
- 指数分布拟合
- 泊松分布拟合
- 对数正态分布拟合
- 拟合优度检验

**3. 回归分析**
- 简单线性回归
- 多元线性回归
- 回归系数及显著性检验
- R²、调整R²
- F统计量
- 残差分析

#### 分布拟合图表设计

**图表说明：**
- 直方图：展示数据的实际分布
- 拟合曲线：展示最佳拟合分布的概率密度函数
- 支持多种分布拟合曲线对比展示

**后端API返回数据：**
```json
{
  "success": true,
  "field": "字段名",
  "sample_size": 100,
  "best_fit": {...},
  "all_fits": [...],
  "chart_data": {
    "histogram": {
      "bin_edges": [0, 10, 20, ...],
      "counts": [5, 12, 18, ...]
    },
    "fitted_curves": [
      {
        "distribution": "正态分布",
        "x": [0, 1, 2, ...],
        "y": [0.01, 0.02, 0.03, ...]
      }
    ]
  }
}
```

**前端展示：**
- 使用 ECharts 绘制直方图和拟合曲线
- 最佳拟合分布曲线用红色突出显示
- 其他分布曲线用灰色显示
- 支持图例切换显示哪些分布曲线
- 直方图和拟合曲线使用相同的x轴区间

#### 回归拟合图表设计

**图表说明：**
- 散点图：展示实际数据点
- 拟合曲线：展示回归模型的预测结果
- 蓝色散点表示实际数据，红色曲线表示拟合结果

**后端API返回数据：**
```json
{
  "success": true,
  "regression_type": "线性回归",
  "dependent_var": "Y",
  "independent_vars": ["X1", "X2"],
  "sample_size": 100,
  "formula": "Y = 1.2345 + 0.5678 * X1 - 0.1234 * X2",
  "intercept": 1.2345,
  "coefficients": {...},
  "chart_data": {
    "actual": [[x1, y1], [x2, y2], ...],
    "predicted": [[x1, y_pred1], [x2, y_pred2], ...]
  },
  "model_stats": {...}
}
```

**前端展示：**
- 使用 ECharts 绘制散点图和拟合曲线
- 蓝色散点表示实际数据
- 红色平滑曲线表示拟合结果
- 显示拟合公式，所有系数保留4位小数
- 公式使用等宽字体显示，蓝色背景突出

#### 拟合公式格式设计

**公式生成规则：**
- 所有系数（包括截距）都保留4位小数
- 使用 Python 字符串格式化 `.4f` 确保4位小数显示
- 正系数前显示 `+` 号
- 负系数前显示 `-` 号
- 示例：`Y = 1.2345 + 0.5678 * X - 0.1234 * Z`

**多项式回归degree设置：**
- 仅在选择多项式回归时显示
- 默认值为 2（二次多项式）
- 支持输入 1-10 之间的整数
- 输入框有 min/max 限制
- 实时验证确保最小为 1

**分布拟合空数据处理：**
- 添加"数据设置"区域
- "去掉空数据"选项，默认勾选
- 勾选时后端会调用 `dropna()` 处理数据

#### 均方误差（MSE）设计

**计算方法：**
- MSE = (1/n) * Σ(y_i - ŷ_i)²
- n：样本数量
- y_i：实际值
- ŷ_i：预测值

**展示位置：**
- 回归分析结果的模型统计区域
- 与R²、F统计量等指标一起展示
- 保留4位小数

#### 相关分析设计

**功能说明：**
- 计算多个数值型字段之间的皮尔逊相关系数
- 生成相关系数矩阵
- 使用热力图可视化相关关系
- 支持选择多个字段进行分析

**相关系数说明：**
- 1.0：完全正相关
- 0.7-0.99：强正相关
- 0.3-0.69：中等正相关
- 0-0.29：弱正相关
- -0.29-0：弱负相关
- -0.69--0.3：中等负相关
- -0.99--0.7：强负相关
- -1.0：完全负相关

**后端API返回数据：**
```json
{
  "success": true,
  "fields": ["字段1", "字段2", "字段3"],
  "correlation_matrix": [
    [1.0, 0.85, 0.32],
    [0.85, 1.0, -0.15],
    [0.32, -0.15, 1.0]
  ],
  "chart_data": {
    "x": ["字段1", "字段2", "字段3"],
    "y": ["字段1", "字段2", "字段3"],
    "values": [[1.0, 0.85, 0.32], [0.85, 1.0, -0.15], [0.32, -0.15, 1.0]]
  }
}
```

**前端展示：**
- 显示相关系数矩阵表格
- 使用ECharts热力图可视化
- 颜色从蓝色（负相关）到红色（正相关）
- 鼠标悬停显示具体的相关系数值

#### 蒙特卡洛分析设计

**功能说明：**
- 基于概率分布进行随机模拟
- 评估风险和不确定性
- 计算结果的概率分布
- 支持多种输入分布（正态、均匀、指数等）

**输入参数：**
- 模拟次数：默认10000次
- 输入变量：每个变量的分布类型和参数
- 计算公式：自定义的计算公式或模型

**输出结果：**
- 模拟结果的统计描述（均值、标准差、分位数）
- 结果的概率分布直方图
- 置信区间（95%、99%）
- 敏感性分析（各输入变量对结果的影响程度）

**后端API返回数据：**
```json
{
  "success": true,
  "simulation_count": 10000,
  "result_stats": {
    "mean": 123.45,
    "std": 12.34,
    "median": 122.50,
    "min": 85.23,
    "max": 165.89,
    "p5": 105.32,
    "p95": 145.67
  },
  "confidence_intervals": {
    "95%": [102.34, 144.56],
    "99%": [98.76, 148.14]
  },
  "chart_data": {
    "histogram": {
      "bin_edges": [80, 90, 100, 110, 120, 130, 140, 150, 160, 170],
      "counts": [100, 500, 1500, 2500, 3000, 1500, 700, 200]
    }
  },
  "sensitivity_analysis": [
    {"variable": "变量1", "impact": 0.65},
    {"variable": "变量2", "impact": 0.25},
    {"variable": "变量3", "impact": 0.10}
  ]
}
```

**前端展示：**
- 输入变量配置区域（分布类型、参数设置）
- 模拟次数设置
- 结果统计展示
- 置信区间展示
- 结果分布直方图
- 敏感性分析柱状图

### 4.11 相关性分析模块（独立页面）

#### 功能说明
- 相关性分析从高级统计中移出，作为独立页面
- 支持选择多个数据快照（可以来自不同数据流）
- 从每个快照选择1个或多个数值型字段
- 支持3种相关系数类型：皮尔逊Pearson、斯皮尔曼Spearman、肯德尔Kendall
- 计算相关系数矩阵
- 热力图可视化相关关系
- 自动识别并展示高相关对（|r| > 0.7）

#### 相关系数类型说明

| 类型 | 适用场景 | 特点 |
|------|----------|------|
| **皮尔逊 Pearson** | 连续变量、线性关系、近似正态分布 | 最常用，衡量线性相关强度 |
| **斯皮尔曼 Spearman** | 连续/有序变量、单调关系 | 基于秩次，对异常值鲁棒 |
| **肯德尔 Kendall** | 小样本、有序数据 | 计算慢，但统计性质好 |

#### 前端页面设计

**页面结构：**
```
┌─────────────────────────────────────────────────────────┐
│                    相关性分析页面                        │
├─────────────────────────────────────────────────────────┤
│  左侧选择区域（350px）      │    右侧结果展示区域        │
│  ┌─────────────────────────┐  │  ┌─────────────────────┐ │
│  │ 选择数据快照（多选）    │  │  │  相关系数热力图     │ │
│  │  - 快照1 [已选择]       │  │  │  (500px高度)         │ │
│  │  - 快照2 [已选择]       │  │  └─────────────────────┘ │
│  │  - 快照3                │  │  ┌─────────────────────┐ │
│  └─────────────────────────┘  │  │  高相关变量对列表   │ │
│  ┌─────────────────────────┐  │  └─────────────────────┘ │
│  │ 已选字段列表             │  │  ┌─────────────────────┐ │
│  │  [快照1] 字段A [✓]      │  │  │  相关系数矩阵表格   │ │
│  │  [快照1] 字段B [✓]      │  │  └─────────────────────┘ │
│  │  [快照2] 字段X [✓]      │  └─────────────────────────┘
│  │  [快照2] 字段Y [✓]      │
│  └─────────────────────────┘  │
│  ┌─────────────────────────┐  │
│  │ 相关系数类型             │  │
│  │ ○ 皮尔逊 Pearson         │  │
│  │ ○ 斯皮尔曼 Spearman      │  │
│  │ ○ 肯德尔 Kendall         │  │
│  └─────────────────────────┘  │
│  ┌─────────────────────────┐  │
│  │ [执行相关性分析] 按钮    │  │
│  └─────────────────────────┘  │
└─────────────────────────────────┘
```

#### 后端API设计

**请求模型：**
```python
class CorrelationFieldRequest(BaseModel):
    snapshot_id: int
    field_name: str

class MultiCorrelationRequest(BaseModel):
    fields: List[CorrelationFieldRequest]
    correlation_method: str = "pearson"  # pearson, spearman, kendall
```

**API端点：**
```
POST   /api/analysis/multi-correlation    # 多数据流字段相关分析
```

**API返回数据格式：**
```json
{
  "success": true,
  "fields": [
    {"snapshot_id": 1, "snapshot_name": "快照1", "field_name": "字段A"},
    {"snapshot_id": 1, "snapshot_name": "快照1", "field_name": "字段B"},
    {"snapshot_id": 2, "snapshot_name": "快照2", "field_name": "字段X"}
  ],
  "correlation_method": "pearson",
  "correlation_matrix": [
    [1.0, 0.85, 0.32],
    [0.85, 1.0, -0.15],
    [0.32, -0.15, 1.0]
  ],
  "high_correlations": [
    {"field1": "快照1-字段A", "field2": "快照1-字段B", "correlation": 0.85, "type": "强正相关"}
  ],
  "chart_data": {
    "x": ["快照1-字段A", "快照1-字段B", "快照2-字段X"],
    "y": ["快照1-字段A", "快照1-字段B", "快照2-字段X"],
    "values": [[1.0, 0.85, 0.32], [0.85, 1.0, -0.15], [0.32, -0.15, 1.0]]
  }
}
```

#### 后端实现逻辑

1. **数据收集阶段**
   - 根据用户选择的字段列表，从每个快照中读取对应字段的数据
   - 将所有字段合并到一个DataFrame中
   - 字段命名格式：`{snapshot_name}-{field_name}` 避免重名冲突

2. **相关系数计算**
   ```python
   # 支持3种相关系数计算方法
   if method == "pearson":
       corr_matrix = df.corr(method='pearson')
   elif method == "spearman":
       corr_matrix = df.corr(method='spearman')
   elif method == "kendall":
       corr_matrix = df.corr(method='kendall')
   ```

3. **高相关对识别**
   - 遍历相关系数矩阵（排除对角线和重复项）
   - 筛选出 |correlation| > 0.7 的变量对
   - 分类：强正相关（>0.7）、强负相关（<-0.7）

#### 前端组件设计

**新增文件：**
- `frontend/src/pages/CorrelationPage.jsx` - 相关性分析独立页面

**导航栏修改：**
- 在分析页面的标签页中移除"相关分析"
- 在主导航栏中添加"相关性"独立入口

**前端状态管理：**
```javascript
const [selectedSnapshots, setSelectedSnapshots] = useState([])
const [selectedFields, setSelectedFields] = useState([])
const [correlationMethod, setCorrelationMethod] = useState('pearson')
const [correlationThreshold, setCorrelationThreshold] = useState(0.7)
const [correlationResult, setCorrelationResult] = useState(null)
```

### 4.12 相关性探索功能设计

#### 功能说明
- 在相关性分析页面中增加"相关性探索"标签页
- 与"相关性分析"标签页可以自由切换
- 支持选择多个数据流的多个字段
- 自动将所有选中字段两两组成一组进行相关性分析
- 提取相关性强的几组数据（相关系数绝对值 > 用户设定的阈值）
- 阈值可由用户设置，默认0.8
- 结果按相关系数绝对值从高到低排序

#### 标签页设计

**页面结构：**
```
┌─────────────────────────────────────────────────────────┐
│                    相关性分析页面                        │
├─────────────────────────────────────────────────────────┤
│  [相关性分析]  [相关性探索]  ← 两个标签页切换         │
├─────────────────────────────────────────────────────────┤
│  左侧选择区域（350px）      │    右侧结果展示区域        │
│  ┌─────────────────────────┐  │  ┌─────────────────────┐ │
│  │ 选择数据快照（多选）    │  │  │  高相关字段对列表   │ │
│  │  - 快照1 [已选择]       │  │  │  (按相关系数排序)   │ │
│  │  - 快照2 [已选择]       │  │  └─────────────────────┘ │
│  │  - 快照3                │  │                         │
│  └─────────────────────────┘  │                         │
│  ┌─────────────────────────┐  │                         │
│  │ 已选字段列表             │  │                         │
│  │  [快照1] 字段A [✓]      │  │                         │
│  │  [快照1] 字段B [✓]      │  │                         │
│  │  [快照2] 字段X [✓]      │  │                         │
│  │  [快照2] 字段Y [✓]      │  │                         │
│  └─────────────────────────┘  │                         │
│  ┌─────────────────────────┐  │                         │
│  │ 相关系数类型             │  │                         │
│  │ ○ 皮尔逊 Pearson         │  │                         │
│  │ ○ 斯皮尔曼 Spearman      │  │                         │
│  │ ○ 肯德尔 Kendall         │  │                         │
│  └─────────────────────────┘  │                         │
│  ┌─────────────────────────┐  │                         │
│  │ 相关性阈值设置          │  │                         │
│  │ 阈值: [0.8 ▼]          │  │                         │
│  └─────────────────────────┘  │                         │
│  ┌─────────────────────────┐  │                         │
│  │ [执行相关性探索] 按钮    │  │                         │
│  └─────────────────────────┘  │                         │
└─────────────────────────────────┘
```

#### 后端API设计

**请求模型：**
```python
class CorrelationExploreRequest(BaseModel):
    fields: List[CorrelationFieldRequest]
    correlation_method: str = "pearson"  # pearson, spearman, kendall
    correlation_threshold: float = 0.8
```

**API端点：**
```
POST   /api/analysis/correlation-explore    # 相关性探索
```

**API返回数据格式：**
```json
{
  "success": true,
  "fields": [
    {"snapshot_id": 1, "snapshot_name": "快照1", "field_name": "字段A"},
    {"snapshot_id": 1, "snapshot_name": "快照1", "field_name": "字段B"},
    {"snapshot_id": 2, "snapshot_name": "快照2", "field_name": "字段X"},
    {"snapshot_id": 2, "snapshot_name": "快照2", "field_name": "字段Y"}
  ],
  "correlation_method": "pearson",
  "correlation_threshold": 0.8,
  "high_correlation_pairs": [
    {
      "field1": {"snapshot_id": 1, "snapshot_name": "快照1", "field_name": "字段A"},
      "field2": {"snapshot_id": 1, "snapshot_name": "快照1", "field_name": "字段B"},
      "correlation": 0.92,
      "type": "强正相关"
    },
    {
      "field1": {"snapshot_id": 1, "snapshot_name": "快照1", "field_name": "字段A"},
      "field2": {"snapshot_id": 2, "snapshot_name": "快照2", "field_name": "字段X"},
      "correlation": -0.85,
      "type": "强负相关"
    }
  ],
  "total_pairs": 6,
  "high_correlation_count": 2
}
```

#### 后端实现逻辑

1. **数据收集阶段**
   - 同相关性分析，收集所有选中字段的数据
   - 合并到一个DataFrame中

2. **两两组合计算**
   - 遍历所有字段两两组合（不重复，不包含自身）
   - 计算每对字段的相关系数
   - 筛选出相关系数绝对值 > 阈值的对

3. **结果排序**
   - 按相关系数绝对值从高到低排序
   - 确保强相关排在前面

#### 前端组件设计

**标签页切换：**
```javascript
const [activeTab, setActiveTab] = useState('analysis')  // 'analysis' | 'explore'
```

**相关性探索结果展示：**
- 表格形式展示高相关字段对
- 列：字段1（快照名+字段名）、字段2（快照名+字段名）、相关系数、类型
- 按相关系数绝对值降序排列
- 相关系数用颜色区分（正相关绿色，负相关红色）
- 显示总共分析了多少对，其中高相关有多少对

### 4.13 蒙特卡洛分析模块（独立页面）

#### 功能说明
- 蒙特卡洛分析从高级统计中移出，作为独立页面
- 支持经典案例和自定义模拟两种模式
- 经典案例1：计算圆周率 π
- 经典案例2：定积分计算
- 经典案例3：排队问题
- 自定义模拟：基于数据快照的变量进行模拟
- 参考：https://cloud.tencent.com/developer/article/1971582

#### 经典案例设计

**案例1：计算圆周率 π**
- 原理：正方形内有一个相切的圆，随机产生点，统计落在圆内的点的比例
- 输入参数：
  - 模拟点数：默认10000
- 输出结果：
  - 估计的π值
  - 误差分析（与真实π的误差）
  - 可视化：正方形、圆、点的分布（圆内点蓝色，圆外点红色）

**案例2：定积分计算**
- 原理：在积分区间内随机产生点，统计落在函数曲线下方的点的比例
- 输入参数：
  - 积分区间：默认[0, 1]
  - 积分函数：默认x²
  - 模拟点数：默认10000
- 输出结果：
  - 估计的积分值
  - 误差分析（与真实积分值的误差）
  - 可视化：正方形、函数曲线、点的分布（曲线下点蓝色，曲线外点红色）

**案例3：排队问题**
- 原理：模拟多个人到达、排队、服务的过程
- 输入参数：
  - 人数：默认20
  - 到达时间分布：默认0-10分钟均匀分布
  - 服务时间分布：默认1-3分钟均匀分布
  - 模拟次数：默认1000
- 输出结果：
  - 等待时间统计（均值、标准差、分布直方图）
  - 服务时间统计
  - 空闲时间统计
  - 可视化：等待时间分布直方图

#### 自定义模拟设计
- 从数据快照选择输入变量
- 为每个变量设置分布类型和参数
- 设置计算公式
- 设置模拟次数
- 输出结果统计（均值、标准差、分位数、置信区间）
- 结果分布直方图
- 敏感性分析

#### 前端页面设计

**页面结构：**
```
┌─────────────────────────────────────────────────────────┐
│                    蒙特卡洛分析页面                        │
├─────────────────────────────────────────────────────────┤
│  [经典案例]  [自定义模拟]  ← 两个标签页切换               │
├─────────────────────────────────────────────────────────┤
│  左侧选择区域（350px）      │    右侧结果展示区域        │
│  ┌─────────────────────────┐  │  ┌─────────────────────┐ │
│  │ 选择案例类型             │  │  │  模拟结果展示       │ │
│  │ ○ 计算圆周率 π          │  │  │  (可视化图表)       │ │
│  │ ○ 定积分计算            │  │  └─────────────────────┘ │
│  │ ○ 排队问题              │  │  ┌─────────────────────┐ │
│  └─────────────────────────┘  │  │  统计结果表格       │ │
│  ┌─────────────────────────┐  │  └─────────────────────┘ │
│  │ 参数设置                │  │                         │
│  │ 模拟点数: [10000 ▼]    │  │                         │
│  │ (根据案例显示不同参数)  │  │                         │
│  └─────────────────────────┘  │                         │
│  ┌─────────────────────────┐  │                         │
│  │ [执行模拟] 按钮          │  │                         │
│  └─────────────────────────┘  │                         │
└─────────────────────────────────┘
```

#### 后端API设计

**请求模型：**
```python
class MonteCarloPiRequest(BaseModel):
    simulation_count: int = 10000

class MonteCarloIntegralRequest(BaseModel):
    x_min: float = 0.0
    x_max: float = 1.0
    function: str = "x**2"
    simulation_count: int = 10000

class MonteCarloQueueRequest(BaseModel):
    num_people: int = 20
    arrival_min: float = 0.0
    arrival_max: float = 10.0
    service_min: float = 1.0
    service_max: float = 3.0
    simulation_count: int = 1000
```

**API端点：**
```
POST   /api/montecarlo/pi          # 计算圆周率
POST   /api/montecarlo/integral    # 定积分计算
POST   /api/montecarlo/queue       # 排队问题
```

**计算圆周率API返回数据格式：**
```json
{
  "success": true,
  "simulation_count": 10000,
  "pi_estimate": 3.1456,
  "error": 0.0040,
  "inside_count": 7864,
  "outside_count": 2136,
  "chart_data": {
    "points_inside": [[x1, y1], [x2, y2], ...],
    "points_outside": [[x3, y3], [x4, y4], ...],
    "circle_center": [0, 0],
    "circle_radius": 1
  }
}
```

**定积分计算API返回数据格式：**
```json
{
  "success": true,
  "simulation_count": 10000,
  "integral_estimate": 0.3345,
  "error": 0.0012,
  "below_count": 3345,
  "above_count": 6655,
  "chart_data": {
    "points_below": [[x1, y1], [x2, y2], ...],
    "points_above": [[x3, y3], [x4, y4], ...],
    "function_curve": [[x, y], ...],
    "x_min": 0,
    "x_max": 1,
    "y_min": 0,
    "y_max": 1
  }
}
```

**排队问题API返回数据格式：**
```json
{
  "success": true,
  "simulation_count": 1000,
  "waiting_time": {
    "mean": 2.34,
    "std": 1.56,
    "median": 2.1,
    "min": 0,
    "max": 8.5
  },
  "service_time": {
    "mean": 2.01,
    "std": 0.57
  },
  "empty_time": {
    "mean": 0.45,
    "std": 0.32
  },
  "chart_data": {
    "waiting_time_histogram": {
      "bin_edges": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
      "counts": [50, 150, 250, 200, 150, 100, 50, 30, 20]
    }
  }
}
```

#### 前端组件设计

**新增文件：**
- `frontend/src/pages/MonteCarloPage.jsx` - 蒙特卡洛分析独立页面

**导航栏修改：**
- 在分析页面的标签页中移除"蒙特卡洛分析"
- 在主导航栏中添加"蒙特卡洛"独立入口

**前端状态管理：**
```javascript
const [activeTab, setActiveTab] = useState('classic')  // 'classic' | 'custom'
const [selectedCase, setSelectedCase] = useState('pi')  // 'pi' | 'integral' | 'queue'
const [piParams, setPiParams] = useState({ simulation_count: 10000 })
const [integralParams, setIntegralParams] = useState({ x_min: 0, x_max: 1, function: 'x**2', simulation_count: 10000 })
const [queueParams, setQueueParams] = useState({ num_people: 20, arrival_min: 0, arrival_max: 10, service_min: 1, service_max: 3, simulation_count: 1000 })
const [result, setResult] = useState(null)
const [loading, setLoading] = useState(false)
```

## 5. 数据库设计

### 5.1 用户表（users）- 新增

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| username | VARCHAR | 用户名（唯一） |
| password_hash | VARCHAR | 密码哈希（bcrypt加密） |
| role | VARCHAR | 角色（admin/user） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 5.2 配置表 (config)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| key | VARCHAR | 配置键 |
| value | TEXT | 配置值（加密存储） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 5.3 数据流表 (data_flows) - 修改

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| user_id | INTEGER | 用户ID（外键，新增） |
| name | VARCHAR | 数据流名称 |
| appkey | VARCHAR | 明道云 appkey |
| sign | VARCHAR | 明道云 sign |
| worksheet_id | VARCHAR | 工作表 ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 5.4 字段类型映射表 (field_types)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| data_flow_id | INTEGER | 数据流 ID（外键） |
| worksheet_id | VARCHAR | 工作表 ID |
| field_id | VARCHAR | 字段 ID |
| field_name | VARCHAR | 字段名 |
| data_type | VARCHAR | 数据类型 |
| is_enabled | TEXT | 是否启用（"true"/"false"） |
| created_at | DATETIME | 创建时间 |

### 5.5 数据快照表 (data_snapshots) - 修改

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| user_id | INTEGER | 用户ID（外键，新增） |
| data_flow_id | INTEGER | 数据流 ID（外键） |
| name | VARCHAR | 快照名称 |
| worksheet_id | VARCHAR | 工作表 ID |
| fields | TEXT | 字段配置（JSON） |
| data | TEXT | 数据内容（JSON） |
| created_at | DATETIME | 创建时间 |

### 5.6 看板表 (dashboards) - 修改

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| user_id | INTEGER | 用户ID（外键，新增） |
| name | VARCHAR | 看板名称 |
| data_snapshot_id | INTEGER | 数据快照 ID（外键） |
| chart_type | VARCHAR | 图表类型 |
| config | TEXT | 图表配置（JSON） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

## 6. 安全设计

### 6.1 API 密钥安全
- 使用加密存储（AES）
- 配置文件权限控制

### 6.2 Python 代码执行安全
- 使用沙箱环境
- 限制可用模块
- 超时控制
- 资源限制

### 6.3 API 安全
- 请求验证
- 输入 sanitize

### 6.4 用户密码安全（新增）
- 使用 bcrypt 算法加密密码
- 密码长度至少6位
- 密码不存储明文，只存储哈希值

### 6.5 会话管理（新增）
- 使用 FastAPI Session 管理用户会话
- 会话超时设置（如24小时）
- 登出时清除会话

### 6.6 权限检查（新增）
- 所有需要认证的API都检查用户登录状态
- 数据操作API检查用户是否有权限（自己的数据或admin）
- admin用户可以查看和操作所有数据

### 4.14 新增图表设计

#### 4.14.1 3D形貌图（Surface3DChart）
- 功能：展示3D表面数据
- 技术：echarts-gl的surface类型
- 数据格式：二维数组 [[z1, z2, ...], ...]
- 特点：支持视角旋转、缩放

#### 4.14.2 联动图表（LinkedChart）
- 功能：折线图和饼图联动，鼠标悬停时同步高亮
- 技术：ECharts的updateAxisPointer事件
- 特点：共享数据集，视觉联动效果

#### 4.14.3 LED晶圆分析图（LEDWaferChart）
- 功能：以3D柱状图为基础，根据波长显示对应颜色
- 技术：波长到RGB颜色转换算法
- 数据字段：x, y, z, wavelength
- 颜色转换：
  - 380-450nm: 紫色到蓝色
  - 450-500nm: 蓝色到青色
  - 500-570nm: 青色到绿色
  - 570-590nm: 绿色到黄色
  - 590-620nm: 黄色到橙色
  - 620-780nm: 橙色到红色
  - 超出范围: 灰色
- tooltip：显示波长信息（保留1位小数）

#### 4.14.4 图表功能优化
- 3D柱状图：添加透明效果，修复Y轴数据读取问题
- 3D形貌图：优化数据结构
- 数据看板：图表高度加大（翻倍）

---

**变更记录**
| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| 1.0 | 2026-02-14 | 架构师 | 初始版本创建 |
| 1.1 | 2026-02-14 | 架构师 | 更新配置管理接口和数据库设计，添加字段启用设置 |
| 1.2 | 2026-02-15 | 架构师 | 更新数据获取模块，添加数据同步和展示功能 |
| 2.0 | 2026-02-15 | 架构师 | 架构重构：后端改为 Spring Boot，集成 Apache Calcite 和 Apache SeaTunnel |
| 2.1 | 2026-02-15 | 架构师 | 混合架构方案：FastAPI + Spring Boot HTTP API 桥接 |
| 2.2 | 2026-02-19 | 架构师 | 更新前端模块架构，添加数据分析模块、丰富图表库（ECharts + DataV）、完善图表设置设计 |
| 2.3 | 2026-02-19 | 架构师 | 取消DataV图表库，新增4个ECharts图表（3D柱状图、堆叠折线图、堆叠柱状图、多Y轴图），添加echarts-gl支持 |
| 2.4 | 2026-02-19 | 架构师 | 新增导入本地CSV和Excel数据功能 |
| 2.5 | 2026-02-19 | 架构师 | 新增字段筛选功能和数据统计功能 |
| 2.6 | 2026-02-19 | 架构师 | 新增操作介绍页面 |
| 2.7 | 2026-02-20 | 架构师 | 新增高级统计分析功能（统计描述、分布拟合、回归分析） |
| 2.8 | 2026-02-20 | 架构师 | 分布拟合分析结果添加拟合分布图（直方图+拟合曲线） |
| 2.9 | 2026-02-20 | 架构师 | 分布拟合添加去掉空数据选项，回归分析添加拟合公式和拟合图，多项式回归支持设置degree，所有系数保留4位小数 |
| 3.0 | 2026-02-21 | 架构师 | 回归模型评估增加均方误差（MSE），新增相关分析和蒙特卡洛分析功能设计 |
| 3.1 | 2026-02-21 | 架构师 | 相关性分析从高级统计中移出，独立成页，支持多数据流字段分析，支持3种相关系数类型 |
| 3.2 | 2026-02-21 | 架构师 | 相关性分析添加筛选高相关字段功能，新增相关性探索标签页 |
| 3.3 | 2026-02-21 | 架构师 | 蒙特卡洛分析从高级统计中移出，独立成页，支持经典案例（圆周率、定积分、排队问题）和自定义模拟，参考腾讯云文章 |
| 3.4 | 2026-02-22 | 架构师 | 新增3D形貌图、联动图表、LED晶圆分析图设计，图表功能优化，第一阶段完成 |
| 3.5 | 2026-02-22 | 架构师 | 新增可部署版本和便携版配置系统设计 |
| 3.6 | 2026-02-22 | 架构师 | 新增用户认证模块设计（用户表、登录/注册、权限控制） |
