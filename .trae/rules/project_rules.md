# PB-BI 项目规则与经验总结

## ACP 敏捷开发流程

本项目采用 ACP（敏捷）开发方式，包含以下核心角色和流程：

### 1. 架构师职责
- 制定系统架构设计
- 汇总和确认需求分析
- 每次迭代时重新确认架构和需求是否变更
- 更新需求分析文档和架构设计文档

### 2. 项目经理职责
- 按照架构和需求制定开发计划
- 跟踪开发计划进度
- 如有更新需求，及时更新开发计划

### 3. 软件开发人员职责
- 前端使用 React 开发，保持编程风格一致
- 进行软件开发
- 如代码审查存在问题，修改并重新提交审查

### 4. 代码审查人员职责
- 对开发代码进行审查
- 反馈审查意见给开发人员
- 对整改后的代码进行重新审查

### 5. 软件测试人员职责
- 编制软件测试用例和测试大纲
- 对软件进行测试
- 反馈测试结果给软件开发人员
- 直到软件通过测试

### 6. ACP 推进专家职责
- 总结软件经验和教训
- 记录到 project_rules.md

---

## 迭代 1.1 经验总结

### 本次迭代完成的功能
1. ✅ 在数据流列表的"测试"按钮后添加"设置"按钮
2. ✅ 点击设置按钮后显示该数据流的所有字段列表
3. ✅ 支持配置字段属性（字段类型）
4. ✅ 支持选择是否使用该字段（启用/禁用）
5. ✅ 保存字段配置功能

### 经验教训

#### 1. 严格遵守ACP流程的重要性
**问题**：在本次迭代初期，没有先更新需求分析和架构设计文档就直接开始编码
**教训**：必须严格按照ACP流程执行，每次迭代都应该：
1. 架构师先确认并更新需求分析和架构设计
2. 项目经理更新开发计划
3. 开发人员进行开发
4. 代码审查人员进行审查
5. 测试人员更新测试大纲
6. ACP专家总结经验教训

#### 2. 数据库设计的灵活性
**经验**：在设计字段启用状态时，使用字符串存储（"true"/"false"）比布尔类型更简单，避免了类型转换的复杂性
**建议**：在前后端交互时，对于简单的布尔标志，可以考虑使用字符串格式

#### 3. 用户体验优化
**经验**：
- 添加"保存配置"按钮，让用户明确知道需要手动保存
- 在标题中显示当前配置的数据流名称，提供清晰的上下文
- 使用灰色的次要按钮样式区分"设置"按钮和其他操作按钮

#### 4. 代码质量
**经验**：
- 代码结构清晰，职责分离明确
- 错误处理完善，提供友好的提示信息
- 样式设计美观，用户体验良好

#### 5. 数据持久化问题
**问题**：修改字段类型后，第二次打开设置页面时显示的还是初始值，没有回显保存的配置
**原因**：在 `get_dataflow_fields` 接口中，只读取了保存的 `is_enabled` 状态，没有同时读取保存的 `data_type`
**解决**：添加 `data_type = saved_fields_dict[field_id].data_type` 来读取保存的字段类型

#### 6. 数据库迁移问题
**问题**：数据库模型更新后，旧数据库缺少新字段导致报错
**解决**：删除旧数据库，让系统重新创建新的数据库结构
**教训**：未来可以考虑使用数据库迁移工具（如 Alembic）来管理数据库版本

#### 7. 明道云 HAP V3 API 使用要点 ⭐重要
**问题**：点击"设置"按钮时字段读取失败
**解决要点**：

1. **API 端点正确使用**
   - 获取应用信息：`GET /v3/app`
   - 获取工作表字段：`GET /v3/app/worksheets/{worksheet_id}`
   - 查询记录：`POST /v3/app/worksheets/{worksheet_id}/rows/list`
   - ⚠️ 注意：不要使用 `/v3/app/info`，应该使用 `/v3/app`

2. **请求头配置**
   ```python
   headers = {
       "Content-Type": "application/json",
       "HAP-Appkey": appkey,  # 注意是 HAP-Appkey 不是 AppKey
       "HAP-Sign": sign        # 注意是 HAP-Sign 不是 Sign
   }
   ```
   ⚠️ 关键：请求头必须使用 `HAP-Appkey` 和 `HAP-Sign`（大写 HAP，大小写敏感）

3. **响应数据格式解析**
   - 成功判断：`result.get("error_code") == 1` 或 `result.get("success") == True`
   - 字段ID可能是 `fieldId` 或 `id`，需要兼容两种情况
   - 字段数据路径：`result.get("data", {}).get("fields", [])`

4. **错误处理**
   - 添加 try-except 捕获所有异常
   - 返回详细的错误信息便于调试
   - 在 API 响应中包含 `error_msg` 和 `raw_response`

5. **调试技巧**
   - 在 API 服务中添加详细的日志输出
   - 返回原始响应数据便于排查问题
   - 前端显示详细的错误信息

### 改进建议

1. **流程改进**：建立明确的迭代启动检查清单，确保每次迭代都按ACP流程执行
2. **文档改进**：在需求分析文档中添加用户故事，更清晰地描述用户需求
3. **测试改进**：在开发过程中同步编写单元测试，提高代码质量
4. **沟通改进**：在每次迭代开始前，先进行简短的团队沟通，确认需求和计划
5. **数据库改进**：引入数据库迁移工具，避免手动删除数据库
6. **API 使用改进**：在调用第三方 API 前，先仔细查阅官方文档，确认正确的端点、请求头和响应格式
7. **调试改进**：在开发阶段就添加详细的日志和调试信息，便于快速定位问题
8. **错误处理改进**：所有 API 调用都要有完善的错误处理，返回对用户友好的错误信息

---

### 迭代 1.2 经验总结

#### 本次迭代完成的功能
1. ✅ 将明道云的数据按数据设置读入（仅启用的字段）
2. ✅ 数据展示在数据页面
3. ✅ 支持数据流选择
4. ✅ 数据表格展示
5. ✅ 数据格式智能转换和显示

#### 经验教训

##### 1. 数据格式处理的重要性
**问题**：明道云API返回的数据格式多样，有嵌套结构、数组、对象等
**解决**：
- 实现 `formatValue` 函数处理各种数据格式
- 支持数组、对象、空值等多种情况的格式化
- 数据展示时自动转换为用户友好的格式

##### 2. 数据流选择UI设计
**经验**：
- 使用网格布局展示数据流选项，视觉效果好
- 选中状态有明显的视觉反馈（边框颜色、背景渐变）
- 悬停效果提升用户体验

##### 3. 数据表格设计
**经验**：
- 表头固定，内容区域可滚动
- 支持横向滚动，适应宽表格
- 行悬停效果方便用户查看
- 序号列固定宽度，便于定位

##### 4. API响应数据解析
**问题**：不同API返回的数据结构可能不同
**解决**：
- 兼容多种数据结构（`row.data` 或直接 `row`）
- 多层级的容错处理
- 确保即使数据结构变化也能正常解析

##### 5. 仅显示启用字段的实现
**经验**：
- 后端查询时过滤 `is_enabled == "true"` 的字段
- 只请求启用的字段ID，减少数据传输
- 前端只展示启用的字段列

### 改进建议（补充）

9. **数据格式处理改进**：建立统一的数据格式转换器，处理各种类型的数据显示
10. **UI组件化改进**：将常用UI组件（数据流选择器、数据表格）抽象为独立组件
11. **分页功能改进**：实现完整的分页功能，支持大量数据展示
12. **数据缓存改进**：对已加载的数据进行缓存，减少重复请求

---

## 迭代 2.0 经验总结（混合架构 - 方案1：HTTP API 桥接）

### 本次迭代规划的功能
1. 采用 FastAPI + Spring Boot 混合架构
2. FastAPI 作为 API 网关，保留现有功能
3. Spring Boot 作为数据服务层，集成 Calcite + SeaTunnel
4. 通过 HTTP/REST API 进行服务间通信
5. 渐进式升级，降低迁移风险

### 经验教训

#### 1. 混合架构的优势
**经验**：
- 渐进式升级：保留现有 FastAPI 代码，降低风险
- 技术栈解耦：FastAPI 和 Spring Boot 独立开发部署
- 风险可控：可以先验证 Calcite + SeaTunnel，再决定是否全面迁移
- 团队友好：Python 和 Java 团队可以并行工作

#### 2. HTTP API 桥接设计要点
**经验**：
- 使用 RESTful JSON 通信，标准成熟
- 需要考虑超时和重试机制
- 错误处理和降级策略很重要
- 建议添加健康检查接口

#### 3. 服务职责划分
**经验**：
- FastAPI：API 网关、配置管理、基础数据查询
- Spring Boot：Calcite SQL 查询、SeaTunnel 数据同步
- 数据库操作主要由 FastAPI 处理，避免双写冲突

#### 4. 部署和运维考虑
**经验**：
- 需要同时部署两个服务
- 考虑服务发现和负载均衡
- 监控和日志需要整合
- 建议使用容器化部署（Docker）

#### 5. 性能考虑
**经验**：
- 增加了一次内部 HTTP 调用，有网络开销
- 建议使用连接池和缓存
- 高并发场景需要特别关注性能
- 可以考虑 gRPC 替代 REST API 提升性能

#### 6. ACP 流程在混合架构中的应用
**经验**：
- 严格按照 6 个角色执行，确保每个环节都有考虑
- 架构师先确认需求和设计
- 开发人员评估实现细节和可行性
- 代码审查人员把关设计质量和风险
- 测试人员制定完整的测试计划（包括容错性测试）
- ACP 专家总结经验教训

### 改进建议（补充）

13. **技术栈决策改进**：在项目初期进行充分的技术调研和选型
14. **架构变更流程改进**：建立技术栈变更的评估和审批流程
15. **风险评估改进**：技术变更前进行完整的风险评估和成本分析
16. **渐进式改进**：优先考虑在现有架构上优化，而非完全重构
17. **技术预研改进**：重大技术决策前先做技术预研和原型验证
18. **混合架构改进**：考虑服务网格（如 Istio）来管理服务间通信
19. **容错性改进**：添加断路器模式（如 Hystrix/Sentinel）提升系统韧性
20. **可观测性改进**：添加分布式追踪（如 Jaeger）便于问题排查
21. **API 设计改进**：内部 API 设计要考虑版本管理和向后兼容

---

## 迭代 2.1 经验总结（数据看板问题修复）

### 本次迭代完成的功能
1. ✅ 重新编写数据看板页面，添加详细调试信息
2. ✅ 修复数据看板图表不显示的问题
3. ✅ 添加数据调试面板，当图表无法显示时显示详细信息

### 经验教训

#### 1. 前后端数据字段命名不一致导致的严重问题 ⭐重要
**问题**：数据看板图表无法显示，数据行数始终为 0
**原因**：后端返回的字段是 `rows`，但前端代码中使用的是 `data`
**解决**：将所有前端代码中的 `snapshotData.data` 改为 `snapshotData.rows`
**教训**：
- 前后端联调时，必须确认字段名完全一致
- 不能仅凭猜测使用字段名，要查看实际的 API 响应
- 建议使用 TypeScript 或类型定义来避免此类问题

#### 2. 调试面板的重要性
**经验**：当图表无法显示时，不要盲目猜测，应该：
1. 先在页面上显示原始数据（调试面板）
2. 添加详细的 console.log 日志
3. 逐步骤排查问题
**本次实现的调试面板包含**：
- 看板配置信息
- 数据快照基本信息（是否存在、字段数、行数）
- 字段列表
- 数据样本（前 3 行）
- 原始数据（如果无法解析）

#### 3. 完整的 console.log 调试信息
**经验**：在关键步骤添加 console.log，包括：
- API 响应数据
- 解析后的数据
- 每个处理步骤的中间结果
- 最终渲染的图表配置

#### 4. 不要轻易重写整个组件
**经验**：用户要求重写时，应该：
1. 先理解问题的根本原因
2. 添加调试信息定位问题
3. 只修复有问题的部分
4. 保持其他功能不变
**本次做法**：虽然用户要求重写，但我们保持了基本界面布局，只修复了数据加载问题

#### 5. 字段去重处理
**发现的问题**：保存的看板配置中 `selectedFields` 有重复字段
**解决**：使用 `[...new Set(config.selectedFields || [])]` 来去重

### 改进建议（补充）

22. **前后端联调改进**：建立 API 文档，明确每个接口的请求和响应格式
23. **数据验证改进**：前端在使用数据前，先验证数据结构是否符合预期
24. **调试工具改进**：在开发阶段，所有页面都应该有调试信息显示功能
25. **代码审查改进**：前后端代码都要经过审查，确保字段名一致

---

## 迭代 2.2 经验总结（取消DataV，新增4个ECharts图表）

### 本次迭代完成的功能
1. ✅ 取消DataV图表库
2. ✅ 安装echarts-gl（3D图表支持）
3. ✅ 创建3D柱状图组件 - bar3d-simplex-noise
4. ✅ 创建堆叠折线图组件 - line-stack
5. ✅ 创建堆叠柱状图组件 - bar-stack-borderRadius
6. ✅ 创建多Y轴图组件 - multiple-y-axis
7. ✅ 更新VisualPage，移除DataV并添加新ECharts图表
8. ✅ 更新ChartSettings支持新图表
9. ✅ 更新需求分析文档（v1.6）
10. ✅ 更新架构设计文档（v2.3）
11. ✅ 更新开发计划文档（v2.2）

### 经验教训

#### 1. 第三方库兼容性问题 ⭐重要
**问题**：@jiaminghi/data-view-react 与 React 18 不兼容
**原因**：DataV 库最后更新在2020年，不支持 React 18 的并发特性
**解决**：
1. 先尝试自行实现DataV风格的组件
2. 用户反馈后，完全取消DataV图表库
3. 用ECharts替代，新增4个更实用的图表类型
**教训**：
- 在选择第三方库前，先检查：
  - 最后更新时间
  - React版本兼容性
  - npm下载量和维护状态
- 优先选择活跃维护的库
- ECharts是一个非常好的选择，功能全面且持续维护

#### 2. 需求变更的处理流程
**经验**：当用户提出需求变更时，应该：
1. 先理解变更的原因和目标
2. 评估变更的影响范围
3. 按照ACP流程执行：
   - 架构师更新需求分析和架构设计
   - 项目经理更新开发计划
   - 开发人员执行开发
   - 代码审查人员审查
   - 测试人员测试
   - ACP专家总结经验
**本次做法**：用户要求取消DataV并新增4个ECharts图表，我们严格按照ACP流程执行

#### 3. echarts-gl的安装和使用
**经验**：
- echarts-gl是ECharts的3D扩展库
- 需要单独安装：`npm install echarts-gl`
- 使用时不需要额外导入，echarts-for-react会自动检测
- 3D图表需要配置grid3D和viewControl
- 建议开启autoRotate提升用户体验

#### 4. 堆叠图表的实现要点
**经验**：
- 堆叠折线图和堆叠柱状图都需要配置`stack: 'total'`
- 堆叠折线图可以添加`areaStyle: {}`显示区域填充
- 堆叠柱状图可以给最后一个系列添加圆角效果
- 都需要支持多选Y轴字段

#### 5. 多Y轴图表的实现要点
**经验**：
- 需要配置多个yAxis对象，每个有独立的yAxisIndex
- 可以交替使用左右位置：`position: index % 2 === 0 ? 'left' : 'right'`
- 第3个及以后的Y轴需要设置offset避免重叠
- 每个Y轴可以设置不同的颜色
- 可以混合使用折线图和柱状图

#### 6. 图表组件的代码风格一致性
**经验**：
- 所有图表组件都使用相同的结构：
  - 导入ReactECharts
  - 解构config参数
  - 处理数据
  - 配置option
  - 返回ReactECharts组件
- 保持props接口一致：`{ data, config = {} }`
- 统一使用`title`默认值，并标明来源（如：'3D柱状图-ECharts'）

### 改进建议（补充）

26. **第三方库选型改进**：建立第三方库选型检查清单，包括：维护状态、兼容性、社区活跃度等
27. **图表库选型改进**：ECharts功能非常全面，建议优先考虑ECharts，再考虑其他库
28. **代码风格一致性改进**：建立图表组件的代码模板，确保所有图表组件风格一致
29. **图表测试改进**：为每个图表组件添加测试用例，确保数据处理逻辑正确
30. **文档维护改进**：每次需求变更后，及时更新所有相关文档（需求分析、架构设计、开发计划）

---

## 迭代 2.3 经验总结（导入本地CSV和Excel数据）

### 本次迭代完成的功能
1. ✅ 确认分析页面已重命名
2. ✅ 确认多表聚合功能已实现
3. ✅ 安装pandas和openpyxl依赖
4. ✅ 后端实现导入CSV和Excel功能API
5. ✅ 前端添加导入本地数据按钮和界面
6. ✅ 更新需求分析文档（v1.7）
7. ✅ 更新架构设计文档（v2.4）
8. ✅ 更新开发计划文档（v2.3）

### 经验教训

#### 1. pandas处理CSV和Excel的便利性 ⭐重要
**经验**：
- pandas是处理表格数据的强大工具
- `pd.read_csv()` 可以轻松读取CSV文件
- `pd.read_excel()` 可以读取Excel文件（需要openpyxl支持）
- `df.to_dict('records')` 可以快速转换为JSON格式
- pandas会自动处理表头和数据类型推断

#### 2. FastAPI文件上传的实现要点
**经验**：
- 使用`UploadFile`和`File`来处理文件上传
- `await file.read()` 读取文件内容
- 使用`io.BytesIO()` 将bytes转换为文件对象供pandas使用
- 文件扩展名检查很重要，确保只接受支持的格式
- 返回前100行数据作为预览，避免数据量过大

#### 3. 前端文件上传的实现要点
**经验**：
- 使用`<input type="file">` 配合`accept=".csv,.xlsx,.xls"`限制文件类型
- 使用`FormData`对象来包装文件和其他参数
- 设置正确的Content-Type：`multipart/form-data`
- axios会自动处理FormData，不需要手动设置Content-Type
- 文件选择后立即验证扩展名，提升用户体验

#### 4. 现有功能的确认流程
**经验**：
- 用户提出需求时，先确认哪些功能已经实现
- 避免重复开发已有的功能
- 本次确认：
  - 分析页面已重命名（之前已完成）
  - 多表聚合功能已实现（之前已完成）
  - 只需要开发导入本地数据功能

#### 5. data_flow_id的灵活处理
**经验**：
- 本地导入的数据没有对应的数据流
- 使用`data_flow_id=0`作为特殊标记
- 生成唯一的`worksheet_id`：`local_{timestamp}`
- 这样可以和明道云的数据区分开

### 改进建议（补充）

31. **文件上传改进**：添加文件大小限制，避免上传过大的文件
32. **数据预览改进**：在导入前显示数据预览，让用户确认数据格式
33. **编码处理改进**：CSV文件可能有不同编码，支持自动检测或手动选择编码
34. **Excel工作表选择改进**：Excel文件可能有多个工作表，支持选择要导入的工作表
35. **错误处理改进**：提供更友好的错误提示，帮助用户理解问题所在

---

## 迭代 2.4 经验总结（本地数据流和多表聚合完善）

### 本次迭代完成的功能
1. ✅ 导入本地数据功能重新设计：先创建本地数据流，再导入文件
2. ✅ 本地数据流设置页面添加导入文件获取字段功能
3. ✅ 数据页面选择本地数据流时自动加载数据
4. ✅ 多表聚合功能升级：使用pandas实现真正的聚合操作（UNION ALL、UNION、JOIN等）
5. ✅ 聚合结果用表格形式展示
6. ✅ 保存聚合结果为新数据快照
7. ✅ 修复NaN值JSON序列化问题
8. ✅ 修复聚合结果保存时数据流不存在问题

### 经验教训

#### 1. 用户需求的深入理解 ⭐重要
**问题**：最初实现的本地数据导入功能流程不符合用户期望
**用户反馈**：应该先创建本地数据流，然后在设置中导入文件获取字段，这样可以设置字段属性
**解决**：完全重构了导入流程，与明道云流程保持一致
**教训**：
- 不要急于实现功能，先充分理解用户的真实需求
- 保持新功能与现有功能的操作流程一致性
- 多站在用户角度思考使用体验

#### 2. pandas数据聚合的强大功能 ⭐重要
**经验**：
- pandas的`concat()`函数可以轻松实现UNION ALL和UNION（配合`drop_duplicates()`）
- pandas的`merge()`函数可以实现各种JOIN操作（inner、left、right、outer）
- 处理多表聚合时，自动识别共同列用于JOIN
- pandas自动处理数据类型转换和缺失值

**实现的聚合类型**：
- UNION ALL：合并所有数据（包括重复）
- UNION：合并数据并去重
- JOIN：内连接（通过共同列）
- LEFT JOIN：左连接
- RIGHT JOIN：右连接
- FULL JOIN：全连接

#### 3. NaN值的JSON序列化问题 ⭐重要
**问题**：数据中的NaN值无法被JSON序列化，导致API报错
**错误信息**：`ValueError: Out of range float values are not JSON compliant: nan`
**解决**：
```python
def clean_nan(obj):
    if isinstance(obj, float) and pd.isna(obj):
        return None
    elif isinstance(obj, dict):
        return {k: clean_nan(v) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [clean_nan(item) for item in obj]
    return obj
```
**教训**：
- pandas读取的数据经常包含NaN值
- 在JSON序列化前必须清理NaN值
- 递归处理复杂的数据结构（字典嵌套、列表等）
- 将NaN转换为None（JSON中的null）

#### 4. 数据流关联的灵活性设计
**问题**：聚合结果保存时没有对应的数据流，导致报错"数据流不存在"
**解决**：修改`create_snapshot` API，当`dataflow_id <= 0`时：
- 不检查数据流是否存在
- 自动生成唯一的`worksheet_id`：`aggregate_{timestamp}`
**教训**：
- 数据库设计要考虑特殊场景（如聚合结果不需要关联数据流）
- API参数要有合理的默认值和特殊值处理
- 向后兼容性很重要，不要破坏现有功能

#### 5. 表格展示的性能优化
**经验**：
- 大数据量时限制前端显示的行数（如前100行）
- 提示用户保存为快照后查看完整数据
- 使用固定表头、可滚动内容区域提升体验
- 表格宽度自适应，支持横向滚动

#### 6. 前端组件复用
**经验**：
- 将常用的UI逻辑（如`formatValue`函数）抽象出来
- 保持代码风格一致
- Modal组件可以在多个页面复用

### 改进建议（补充）

36. **用户引导改进**：为新功能添加操作指引或帮助文档
37. **聚合功能改进**：支持自定义JOIN字段，不依赖自动识别
38. **数据预览改进**：聚合前显示每个快照的样本数据
39. **批量操作改进**：支持一次选择多个快照进行批量操作
40. **历史记录改进**：保存聚合操作历史，方便重复执行
41. **数据验证改进**：聚合前检查数据兼容性
42. **进度显示改进**：大数据量聚合时显示进度条

---

## 迭代 2.5 经验总结（字段筛选和数据统计功能）

### 本次迭代完成的功能
1. ✅ 架构师：更新需求分析文档（v1.7→v1.8）
2. ✅ 架构师：更新架构设计文档（v2.4→v2.5）
3. ✅ 项目经理：更新开发计划文档（v2.3→v2.4）
4. ✅ 开发人员：更新分析页面标签页（多表聚合、字段筛选、数据统计）
5. ✅ 开发人员：实现字段筛选功能（选择字段形成新数据源）
6. ✅ 开发人员：实现数据统计功能（计数、求和、平均值、最小值、最大值）
7. ✅ 代码审查人员：审查代码并反馈问题
8. ✅ 开发人员：修复数据统计功能，添加保存为新快照按钮

### 经验教训

#### 1. 严格遵守ACP流程的重要性 ⭐重要
**问题**：在本次迭代初期，用户提出新需求后，我直接开始编码，没有按照ACP流程执行
**用户反馈**："是不是该执行正常的开发流程，怎么你直接开始编了"
**解决**：立即停止编码，严格按照ACP流程执行：
1. 架构师：更新需求分析文档
2. 架构师：更新架构设计文档
3. 项目经理：更新开发计划文档
4. 开发人员：开始编码
5. 代码审查人员：审查代码
6. ACP推进专家：总结经验教训
**教训**：
- 必须严格按照ACP流程执行，不能跳过任何环节
- 每次迭代都应该先更新文档，再开始编码
- 用户提醒后要立即纠正，不要继续错误的做法

#### 2. 字段筛选功能的设计要点
**经验**：
- 先选择数据快照，再加载该快照的所有字段
- 默认全选所有字段，用户可以取消勾选不需要的字段
- 实时预览筛选后的数据（前100行）
- 支持保存为新的数据快照
- 保持与多表聚合功能相同的界面风格和操作流程

#### 3. 数据统计功能的设计要点
**经验**：
- 自动识别数值型字段（`data_type === 'number'`）
- 计算常用统计指标：计数、求和、平均值、最小值、最大值
- 平均值保留2位小数
- 统计结果以表格形式展示，数值右对齐
- 将统计结果转换为标准的`fields`和`rows`格式，便于保存为新快照
- 支持保存统计结果为新的数据快照

#### 4. 代码审查的重要性 ⭐重要
**经验**：
- 代码审查人员要仔细检查每个功能的完整性
- 本次发现的问题：数据统计功能缺少保存为新快照的按钮
- 及时反馈问题，开发人员立即修复
- 确保所有功能都符合用户需求（保存结果是用户需求的一部分）
- 代码审查不仅要看代码质量，还要看功能完整性

#### 5. 功能间的一致性设计
**经验**：
- 三个标签页（多表聚合、字段筛选、数据统计）使用相同的布局（300px侧边栏 + 主内容区）
- 使用相同的UI组件（卡片、按钮、表格、Modal）
- 保存功能使用相同的Modal组件
- 表格都限制显示前100行，并提示用户保存为快照查看完整数据
- 保持代码风格一致，便于维护和扩展

#### 6. 状态管理的清晰性
**经验**：
- 每个标签页使用独立的状态变量，避免相互干扰
- 字段筛选：`selectedSnapshotForFilter`、`snapshotData`、`selectedFields`、`filterResult`
- 数据统计：`selectedSnapshotForStats`、`statsResult`
- 切换标签页时不需要重置其他标签页的状态，提升用户体验
- 加载状态统一使用`loading`变量，避免多个加载状态变量

### 改进建议（补充）

43. **字段筛选改进**：支持字段排序，方便用户调整字段顺序
44. **数据统计改进**：支持自定义统计指标（如中位数、方差、标准差等）
45. **数据统计改进**：支持按某个字段分组统计（GROUP BY）
46. **用户体验改进**：添加操作指引或帮助提示，引导用户使用新功能
47. **性能优化改进**：大数据量时考虑使用Web Worker进行统计计算，避免阻塞UI
48. **数据导出改进**：支持将筛选结果或统计结果导出为CSV或Excel文件

---

## 迭代 2.6 经验总结（操作介绍页面）

### 本次迭代完成的功能
1. ✅ 架构师：更新需求分析文档（v1.8→v1.9）
2. ✅ 架构师：更新架构设计文档（v2.5→v2.6）
3. ✅ 项目经理：更新开发计划文档（v2.4→v2.5）
4. ✅ 开发人员：创建操作介绍页面（GuidePage.jsx）
5. ✅ 开发人员：在导航栏添加操作指南入口
6. ✅ 开发人员：实现功能模块卡片（配置管理、数据获取、数据分析、数据可视化）
7. ✅ 开发人员：每个卡片包含功能描述、主要功能、操作步骤、快速跳转按钮
8. ✅ 开发人员：添加使用提示区域
9. ✅ 开发人员：实现快速跳转功能（点击按钮直接跳转到对应页面）

### 经验教训

#### 1. 用户教育的重要性 ⭐重要
**经验**：
- 即使功能很强大，如果用户不知道怎么用，价值也会大打折扣
- 操作介绍页面可以大大降低用户的学习成本
- 提供清晰的操作步骤比复杂的功能更重要
- 快速跳转功能让用户看完说明就能立即实践

#### 2. 卡片式布局的优点
**经验**：
- 使用卡片式布局展示不同功能模块，视觉清晰
- 每个卡片独立，便于用户专注阅读
- 使用不同颜色区分不同模块，提升识别度
- 添加emoji图标让页面更生动有趣

#### 3. 操作指导的结构化设计
**经验**：
- 每个功能模块包含：模块介绍、主要功能、操作步骤、快速跳转
- 主要功能用列表形式，清晰明了
- 操作步骤用有序列表，用户可以按步骤操作
- 快速跳转按钮放在卡片底部，方便用户操作

#### 4. 欢迎横幅的设计
**经验**：
- 使用渐变色背景吸引用户注意力
- 简洁明了地介绍平台用途
- 引导用户继续阅读下方内容
- 视觉效果好，提升第一印象

#### 5. 导航栏的特殊样式
**经验**：
- 操作指南按钮使用绿色背景，与其他导航项区分开
- 让用户一眼就能找到帮助入口
- 特殊样式也暗示这是一个重要的功能

#### 6. 团队默契度提升
**用户反馈**："挺好，我感觉我们原来越默契了"
**经验**：
- 严格按照ACP流程执行，每个角色各司其职
- 先更新文档，再开始编码，避免需求偏差
- 用户需求明确后，快速响应并完成
- 保持沟通顺畅，及时确认需求

### 改进建议（补充）

49. **操作指南改进**：添加视频教程或GIF动画演示
50. **操作指南改进**：支持搜索功能，快速找到需要的功能说明
51. **操作指南改进**：添加常见问题FAQ区域
52. **操作指南改进**：支持用户反馈，收集使用问题和建议
53. **用户体验改进**：在每个功能页面添加"帮助"按钮，快速跳转到对应说明
54. **内容更新改进**：操作指南内容随功能更新同步更新

---

## 迭代 2.7 经验总结（高级统计分析功能）

### 本次迭代完成的功能
1. ✅ 架构师：更新需求分析文档（v1.9→v2.0）
2. ✅ 架构师：更新架构设计文档（v2.6→v2.7）
3. ✅ 项目经理：更新开发计划文档（v2.5→v2.6）
4. ✅ 开发人员：安装 statsmodels 和 scikit-learn 依赖
5. ✅ 开发人员：后端实现统计描述分析 API
6. ✅ 开发人员：后端实现分布拟合分析 API
7. ✅ 开发人员：后端实现回归分析 API
8. ✅ 开发人员：前端创建 AdvancedStats 组件
9. ✅ 开发人员：前端分析页面添加"高级统计"标签页
10. ✅ 开发人员：实现统计描述分析界面
11. ✅ 开发人员：实现分布拟合分析界面
12. ✅ 开发人员：实现回归分析界面
13. ✅ 代码审查人员：审查代码
14. ✅ ACP专家：总结经验教训

### 经验教训

#### 1. 第三方统计库的强大功能 ⭐重要
**经验**：
- statsmodels 提供完整的统计建模和计量经济学分析功能
- scikit-learn 提供强大的机器学习算法支持
- scipy 提供科学计算和统计检验功能
- 这些库的组合可以满足大部分统计分析需求

**实现的功能**：
- 统计描述：均值、中位数、标准差、偏度、峰度、置信区间等
- 正态性检验：Shapiro-Wilk、Kolmogorov-Smirnov、Jarque-Bera
- 分布拟合：正态分布、指数分布、伽马分布、对数正态分布、泊松分布
- 回归分析：线性回归、岭回归、Lasso回归、多项式回归

#### 2. 后端API设计的模块化
**经验**：
- 将不同的分析类型拆分为独立的API端点
- 每个API职责单一，便于维护和扩展
- 统一的返回格式，便于前端处理

**API设计**：
```
POST /api/analysis/statistical   # 统计描述分析
POST /api/analysis/distribution  # 分布拟合分析
POST /api/analysis/regression    # 回归分析
```

#### 3. 前端组件的独立性设计
**经验**：
- 将高级统计功能封装为独立的 AdvancedStats 组件
- 组件内部管理自己的状态，减少与父组件的耦合
- 通过 props 传递必要的数据，保持组件的可复用性

#### 4. 数据类型处理的重要性
**经验**：
- 使用 pandas 的 `pd.to_numeric()` 将数据转换为数值类型
- 使用 `errors='coerce'` 将无法转换的值设为 NaN
- 使用 `dropna()` 删除缺失值，确保分析的有效性

#### 5. 统计结果的展示设计
**经验**：
- 使用卡片式布局展示不同类型的统计结果
- 使用表格展示回归系数和检验结果
- 使用颜色区分显著性（绿色表示显著，灰色表示不显著）
- 突出显示最佳拟合分布

#### 6. 代码编辑时的注意事项
**问题**：在修改 AnalysisPage.jsx 时不小心引入了重复代码
**原因**：搜索替换时没有精确定位，导致代码重复
**解决**：仔细检查代码结构，删除重复部分
**教训**：
- 进行大范围替换前先备份文件
- 替换后仔细检查代码结构
- 使用版本控制工具（如Git）便于回滚

### 改进建议（补充）

55. **统计功能改进**：添加更多统计检验（方差分析、卡方检验等）
56. **统计功能改进**：支持时间序列分析
57. **可视化改进**：添加分布直方图、QQ图、回归线图等可视化
58. **结果导出改进**：支持将分析结果导出为报告（PDF或Word）
59. **模型保存改进**：支持保存训练好的回归模型，用于预测新数据
60. **批量分析改进**：支持对多个字段同时进行统计分析

---

## 迭代 2.8 经验总结（高级统计分析功能完善）

### 本次迭代完成的功能
1. ✅ 分布拟合：添加"数据设置"区域，将"去掉空数据"选项独立出来
2. ✅ 分布拟合：修复直方图和拟合曲线区间不一致问题
3. ✅ 回归分析：添加拟合公式显示（所有系数保留4位小数）
4. ✅ 回归分析：添加回归拟合图（蓝色散点表示实际数据，红色曲线表示拟合结果）
5. ✅ 多项式回归：添加degree设置输入框（1-10，默认2）
6. ✅ 后端修改：所有回归类型的公式生成都使用.4f格式化
7. ✅ 更新需求分析文档（v2.1→v2.2）
8. ✅ 更新架构设计文档（v2.8→v2.9）
9. ✅ 更新开发计划文档（v2.7→v2.8）

### 经验教训

#### 1. 用户反馈的快速响应 ⭐重要
**问题**：用户在测试过程中发现多个问题需要修复
**解决**：快速响应并逐一修复
**经验**：
- 用户反馈是最好的测试手段，要认真对待每一个反馈
- 每次迭代后应该邀请用户测试，收集反馈
- 对于小问题要快速修复，不要积累

**本次修复的问题**：
- 直方图和拟合曲线区间不一致
- 多项式回归无法设置degree
- 回归公式系数显示小数位数不足

#### 2. 字符串格式化的重要性 ⭐重要
**问题**：使用round()函数后，Python会自动省略末尾的0，导致显示位数不一致
**原因**：`round(1.2345, 4)` 结果是 `1.2345`，但 `round(1.2, 4)` 结果是 `1.2` 而不是 `1.2000`
**解决**：使用字符串格式化 `.4f` 确保显示4位小数
**教训**：
- 对于需要固定小数位数显示的场景，不要只依赖round()
- 使用字符串格式化来确保显示格式一致
- 例如：`f"{value:.4f}"` 会强制显示4位小数

#### 3. ECharts图表数据格式的注意事项
**问题**：直方图和拟合曲线不在同一个区间
**原因**：直方图使用bin中心作为x值，拟合曲线使用原始x值，但x轴范围没有统一
**解决**：
- 直方图数据格式改为 `[[x_center, count], ...]`
- 明确设置x轴的min和max为直方图的bin_edges范围
- 确保直方图和拟合曲线使用相同的x轴区间

#### 4. UI分组设计的重要性
**经验**：
- 将相关的设置选项分组展示，用户体验更好
- 例如：分布拟合的"去掉空数据"选项放在"数据设置"区域
- 多项式回归的degree设置只在选择多项式回归时显示
- 这样界面更清晰，用户不会被无关选项干扰

#### 5. 回归分析可视化的设计要点
**经验**：
- 散点图展示实际数据点，让用户看到原始数据分布
- 平滑曲线展示拟合结果，清晰显示模型趋势
- 蓝色散点 + 红色曲线是经典且有效的配色方案
- 数据点按x轴排序，确保曲线显示连续
- 拟合公式使用等宽字体显示，便于阅读

#### 6. ACP流程的持续执行
**经验**：
- 即使是小迭代，也要严格按照ACP流程执行
- 本次迭代虽然只是完善功能，但依然：
  1. 架构师：更新需求分析和架构设计
  2. 项目经理：更新开发计划
  3. 开发人员：进行开发
  4. 代码审查人员：审查代码
  5. ACP专家：总结经验教训
- 流程是质量的保障

### 改进建议（补充）

63. **用户反馈改进**：建立用户反馈收集机制，每次迭代后主动收集用户意见
64. **格式化改进**：对于数值显示，优先考虑字符串格式化而非仅依赖round()
65. **图表测试改进**：开发图表功能时，要测试多种数据分布场景
66. **UI分组改进**：界面设计时要考虑信息分组，避免选项混乱
67. **可视化设计改进**：统计分析的可视化要同时展示原始数据和模型结果
68. **迭代流程改进**：即使是小功能完善，也要保持ACP流程的完整性

---

## 迭代 2.9 经验总结（回归模型MSE、相关分析、蒙特卡洛分析）

### 本次迭代完成的功能
1. ✅ 回归模型评估增加均方误差（MSE）
2. ✅ 数据分析增加相关分析功能（皮尔逊相关系数、热力图展示）
3. ✅ 数据分析增加蒙特卡洛分析功能（多种分布、公式计算、敏感性分析）
4. ✅ 更新需求分析文档（v2.2→v2.3）
5. ✅ 更新架构设计文档（v2.9→v3.0）
6. ✅ 更新开发计划文档（v2.8→v2.9）

### 经验教训

#### 1. 均方误差（MSE）的重要性 ⭐重要
**经验**：
- MSE是回归模型评估的重要指标，衡量预测值与实际值的平均平方差
- MSE越小，说明模型拟合效果越好
- 与R²配合使用，可以更全面地评估模型性能
- sklearn的`mean_squared_error`函数可以方便地计算MSE

**实现要点**：
```python
from sklearn.metrics import mean_squared_error
mse = mean_squared_error(y, y_pred)
```

#### 2. 相关分析的实现要点
**经验**：
- 皮尔逊相关系数是衡量两个变量线性关系强度的常用指标
- 取值范围[-1, 1]，绝对值越大相关性越强
- pandas的`corr(method='pearson')`可以方便地计算相关系数矩阵
- 热力图是可视化相关系数矩阵的最佳方式

**可视化设计**：
- 蓝色表示负相关，红色表示正相关
- 颜色深浅表示相关程度
- 鼠标悬停显示具体数值
- 矩阵中同时显示数值和颜色

#### 3. 蒙特卡洛分析的设计要点 ⭐重要
**经验**：
- 蒙特卡洛分析通过大量随机模拟来估计结果的概率分布
- 支持多种概率分布：正态、均匀、指数、伽马
- 用户可以自定义计算公式（如：a + b * c）
- 需要考虑公式执行的安全性（使用eval时要限制__builtins__）
- 敏感性分析可以帮助识别哪些输入变量对结果影响最大

**实现的功能**：
- 结果统计：均值、标准差、中位数、最小值、最大值、分位数
- 置信区间：95%和99%置信区间
- 分布直方图：可视化结果分布
- 敏感性分析：按相关系数排序显示各变量的影响程度

#### 4. 安全执行用户公式的注意事项
**问题**：使用eval执行用户输入的公式存在安全风险
**解决**：
```python
# 安全地执行公式
local_vars = variable_data.copy()
results = []

for i in range(simulation_count):
    eval_vars = {k: v[i] for k, v in variable_data.items()}
    try:
        result = eval(request.formula, {"__builtins__": {}}, eval_vars)
        results.append(float(result))
    except:
        results.append(np.nan)
```
**经验**：
- 限制`__builtins__`为空字典，防止用户调用危险函数
- 每次循环都创建新的eval_vars，避免变量污染
- 捕获异常，防止单个计算失败导致整个模拟失败

#### 5. ECharts热力图的配置要点
**经验**：
- 使用`type: 'heatmap'`创建热力图
- `visualMap`配置颜色映射范围[-1, 1]
- `label.show: true`在每个格子显示数值
- `emphasis`配置悬停效果
- tooltip格式化显示相关系数

#### 6. 前端组件的状态管理
**经验**：
- 每个分析功能使用独立的状态变量，避免相互干扰
- 状态包括：输入参数、加载状态、分析结果
- 切换标签页时保持其他标签页的状态，提升用户体验
- 使用统一的loading状态变量

#### 7. ACP流程的持续执行 ⭐重要
**经验**：
- 即使是功能增强迭代，也要严格按照ACP流程执行
- 本次迭代严格执行了：
  1. 架构师：更新需求分析和架构设计
  2. 项目经理：更新开发计划
  3. 开发人员：进行开发
  4. 代码审查人员：审查代码
  5. ACP专家：总结经验教训
- 流程是质量的保障，每个环节都不能少

### 改进建议（补充）

69. **安全改进**：蒙特卡洛分析的公式执行可以进一步限制，使用AST解析而不是eval
70. **相关分析改进**：支持斯皮尔曼秩相关系数和肯德尔秩相关系数
71. **蒙特卡洛改进**：支持更多分布类型（beta分布、t分布、卡方分布等）
72. **可视化改进**：相关分析支持散点图矩阵，蒙特卡洛分析支持累积分布图
73. **结果导出改进**：支持将分析结果导出为报告
74. **预设模板改进**：为常用的蒙特卡洛分析场景提供预设模板
75. **用户教育改进**：为新功能添加操作提示和帮助文档

---

## 版本历史

| 版本 | 日期 | 迭代 | 说明 |
|------|------|------|------|
| 1.0 | 2026-02-14 | 迭代 1.1 | 初始版本，记录迭代 1.1 的经验教训 |
| 1.1 | 2026-02-14 | 迭代 1.1 | 补充明道云 HAP V3 API 使用要点和测试出错解决要点 |
| 1.2 | 2026-02-15 | 迭代 1.2 | 补充数据同步和展示功能的经验教训 |
| 2.0 | 2026-02-15 | 迭代 2.0 | 补充混合架构（FastAPI + Spring Boot 桥接）的经验教训 |
| 2.1 | 2026-02-15 | 迭代 2.1 | 补充数据看板问题修复的经验教训 |
| 2.2 | 2026-02-19 | 迭代 2.2 | 补充取消DataV、新增4个ECharts图表的经验教训 |
| 2.3 | 2026-02-19 | 迭代 2.3 | 补充导入本地CSV和Excel数据的经验教训 |
| 2.4 | 2026-02-19 | 迭代 2.4 | 补充本地数据流重构和多表聚合功能完善的经验教训
| 2.5 | 2026-02-19 | 迭代 2.5 | 补充字段筛选和数据统计功能的经验教训
| 2.6 | 2026-02-19 | 迭代 2.6 | 补充操作介绍页面的经验教训
| 2.7 | 2026-02-20 | 迭代 2.7 | 补充高级统计分析功能的经验教训
| 2.8 | 2026-02-20 | 迭代 2.8 | 补充高级统计分析功能完善的经验教训
| 2.9 | 2026-02-20 | 迭代 2.9 | 补充回归模型MSE、相关分析、蒙特卡洛分析的经验教训
| 2.10 | 2026-02-20 | 迭代 2.10 | 补充相关性分析独立成页、支持多数据流字段分析的经验教训 |
| 2.11 | 2026-02-20 | 迭代 2.11 | 补充相关性探索功能（筛选高相关字段、阈值设置）的经验教训 |
| 2.12 | 2026-02-20 | 迭代 2.12 | 补充蒙特卡洛分析独立成页（经典案例）的经验教训 |
| 3.0 | 2026-02-22 | 迭代 3.0 | 补充可部署版本生成（局域网部署）的经验教训 |
| 3.1 | 2026-02-23 | 迭代 3.1 | 补充便携版优化与配置系统（config.ini配置系统）的经验教训 |

---

## 迭代 3.0 经验总结（可部署版本生成）

### 本次迭代完成的功能
1. ✅ 架构师确认部署需求
2. ✅ 项目经理制定部署计划
3. ✅ 后端部署配置（host=0.0.0.0）
4. ✅ 前端构建优化
5. ✅ 创建启动脚本（start-backend.bat、start-frontend.bat）
6. ✅ 创建部署说明文档（DEPLOYMENT.md）
7. ✅ 测试本地部署
8. ✅ 测试局域网访问

### 经验教训

#### 1. 局域网部署的网络配置 ⭐重要
**问题**：默认情况下，FastAPI只监听localhost，其他机器无法访问
**解决**：将后端绑定地址改为`0.0.0.0`，监听所有网络接口
**教训**：
- 开发时通常使用`127.0.0.1`或`localhost`
- 部署时需要改为`0.0.0.0`才能被其他机器访问
- 前端serve也需要确保监听所有接口

#### 2. 前端构建的部署优化
**经验**：
- 使用`npm run build`进行生产构建
- 构建产物在`frontend/dist`目录
- 使用`serve`静态服务器托管构建产物
- `serve -s`模式适合单页应用（SPA）

#### 3. 启动脚本的便捷性
**经验**：
- 创建批处理脚本自动启动后端和前端
- 使用`start`命令在新窗口启动
- 添加`chcp 65001`支持中文输出
- 脚本放在项目根目录，便于用户操作

#### 4. 端口占用的处理
**经验**：
- 默认前端端口3000，后端端口8000
- 如果端口被占用，serve会自动使用下一个端口
- 用户需要注意实际使用的端口号

#### 5. 部署文档的重要性
**经验**：
- 创建DEPLOYMENT.md详细说明部署步骤
- 包含环境要求、安装步骤、启动方法
- 提供常见问题解答
- 文档是用户体验的重要组成部分

---

## 迭代 3.1 经验总结（便携版优化与配置系统）

### 本次迭代完成的功能
1. ✅ 创建配置文件示例（config.example.ini）
2. ✅ 创建配置读取脚本（load-config.bat）
3. ✅ 修改后端启动脚本支持配置系统
4. ✅ 修改前端启动脚本支持配置系统
5. ✅ 修改前端API地址为动态获取
6. ✅ 创建更新便携版前端脚本（update-portable.bat）
7. ✅ 更新README.md便携版说明
8. ✅ GitHub仓库更新
9. ✅ 局域网测试验证成功

### 经验教训

#### 1. 便携版部署的核心挑战 ⭐重要
**问题**：用户需要在没有安装Python和Node.js的机器上运行程序
**解决**：创建完整的便携版，包含预安装的Python和Node.js运行时
**教训**：
- 便携版需要将所有依赖打包，包括Python和Node.js运行时
- 不能假设目标机器上有任何开发环境
- 需要考虑路径的灵活性，因为运行位置可能不同

#### 2. 配置文件系统设计的要点
**经验**：
- 使用INI格式配置文件，简单易读
- 所有配置项都有默认值，与当前成功配置一致
- 注释说明每个配置项的用途
- 配置文件使用示例文件（config.example.ini）避免误修改

#### 3. 批处理脚本的路径处理
**经验**：
- 使用`%~dp0`获取脚本所在目录，实现相对路径
- 使用`setlocal enabledelayedexpansion`处理变量延迟
- 配置文件使用`endlocal`将变量传递给调用者
- 注意批处理变量赋值的特殊性

#### 4. 前端API地址的动态获取
**问题**：便携版界面显示空白，原因是前端API地址不正确
**原因**：之前使用相对路径`/api`，在serve模式下无法代理到后端
**解决**：使用`window.location.protocol + '//' + window.location.hostname + ':8000'`动态获取
**教训**：
- 前端API地址不能硬编码，要考虑不同部署环境
- 使用window.location可以自动获取当前主机信息
- 但端口号仍然硬编码，需要进一步优化

#### 5. 便携版打包的完整性
**经验**：
- 需要包含Python运行时（python.exe和必要文件）
- 需要包含Node.js运行时
- 需要包含Python依赖库（site-packages）
- 需要包含npm全局模块（serve等）
- 需要包含配置文件示例
- 需要包含启动脚本

#### 6. 局域网部署的验证
**经验**：
- 后端需要绑定到`0.0.0.0`才能被其他机器访问
- 前端serve需要监听所有网络接口
- 防火墙可能需要开放端口
- 使用`COMPUTERNAME`获取主机名在局域网可能不可靠

#### 7. GitHub发布的注意事项
**经验**：
- 便携版输出目录应该排除在版本控制外（.gitignore）
- 提交信息要清晰描述本次更新的内容
- 可以创建临时的批处理脚本简化Git操作

### 改进建议（补充）

96. **API配置改进**：前端API端口也应从配置文件读取，而非硬编码
97. **自动化改进**：创建一键打包脚本，自动化整个便携版生成过程
98. **路径检测改进**：启动时检测运行时路径是否存在，给出友好提示
99. **错误处理改进**：配置文件格式错误时给出明确错误信息
100. **文档改进**：创建详细的便携版使用说明文档

---

## 迭代 2.11 经验总结（相关性探索功能）

### 本次迭代完成的功能
1. ✅ 相关性分析中增加筛选高相关性字段功能（可配置阈值）
2. ✅ 相关性分析后面增加相关性探索标签，两者可以切换
3. ✅ 保留现在的作为相关性分析，新增相关性探索
4. ✅ 相关性探索可以选择多个数据流的多个字段，两两组成一组进行相关性分析
5. ✅ 将相关性强的几组数据提取出来，按相关系数排序
6. ✅ 相关性的判据可以客户设置约束，默认相关性分析为0.7，相关性探索为0.8

### 经验教训

#### 1. 标签页设计的重要性 ⭐重要
**问题**：用户需要两种不同的相关性分析功能：
- 相关性分析：展示完整的相关系数矩阵和热力图
- 相关性探索：只关注高相关对，按相关系数排序
**解决**：使用标签页将两者分开，保持同一界面下的功能切换
**教训**：
- 当功能相似但关注点不同时，标签页是很好的选择
- 标签页可以共享左侧的选择区域，减少重复代码
- 不同标签页可以有独立的默认参数（如阈值）

#### 2. 可配置阈值的设计要点
**经验**：
- 不同的使用场景需要不同的阈值：
  - 相关性分析：阈值0.7，找到较强的相关
  - 相关性探索：阈值0.8，只找最强的相关
- 让用户可以自由调整阈值，适应不同的需求
- 在界面上明确显示当前阈值和默认值

#### 3. 相关性探索的排序设计
**经验**：
- 按相关系数绝对值从高到低排序，让用户一眼看到最强的关联
- 展示统计信息：总对数、高相关对数，让用户了解整体情况
- 高相关对的表格设计要清晰，包含字段所属快照名

#### 4. 前端状态管理的清晰性
**经验**：
- 使用`activeTab`状态变量控制当前显示的标签页
- 两个标签页使用独立的结果状态：`correlationResult` vs `exploreResult`
- 两个标签页使用独立的阈值状态：`correlationThresholdForAnalysis` vs `correlationThresholdForExplore`
- 切换标签页时保留各自的状态，提升用户体验

#### 5. 后端API的复用和扩展
**经验**：
- 相关性分析和相关性探索共享相同的数据收集和合并逻辑
- 但返回不同的结果格式：
  - 相关性分析：返回完整矩阵、热力图数据、高相关对列表
  - 相关性探索：返回高相关对排序列表、统计信息
- 使用两个独立的API端点，职责清晰

#### 6. ACP流程的持续执行 ⭐重要
**经验**：
- 即使是小功能迭代，也要严格按照ACP流程执行
- 本次迭代严格执行了：
  1. 架构师：更新需求分析和架构设计
  2. 项目经理：更新开发计划
  3. 开发人员：进行开发
  4. 代码审查人员：审查代码
  5. ACP专家：总结经验教训
- 流程是质量的保障，每个环节都不能少
- 用户需求明确后，快速响应并完成

### 改进建议（补充）

82. **相关性探索改进**：支持查看任意两个字段的散点图
83. **相关性探索改进**：支持保存高相关对结果
84. **用户体验改进**：相关性探索页面添加"使用说明"区域
85. **性能优化改进**：字段数量多时可以分批计算
86. **历史记录改进**：保存相关性分析历史，方便重复查看
87. **阈值预设改进**：提供常用阈值预设选项（0.5、0.7、0.8、0.9）

---

## 迭代 2.12 经验总结（蒙特卡洛分析独立成页）

### 本次迭代完成的功能
1. ✅ 将蒙特卡洛分析从高级统计中移出，创建独立页面
2. ✅ 蒙特卡洛分析页面添加标签页切换（经典案例/自定义模拟）
3. ✅ 经典案例1：计算圆周率 π（蒙特卡洛方法）
4. ✅ 经典案例2：定积分计算（蒙特卡洛方法）
5. ✅ 经典案例3：排队问题模拟
6. ✅ 后端API新增三个经典蒙特卡洛案例端点
7. ✅ 导航栏添加蒙特卡洛入口（橙色背景）
8. ✅ 将"分析"导航项重命名为"高级统计"
9. ✅ 从AdvancedStats.jsx中完全移除蒙特卡洛相关代码

### 经验教训

#### 1. 功能模块化的持续重要性 ⭐重要
**问题**：蒙特卡洛分析与高级统计的其他功能（统计描述、分布拟合、回归分析）本质不同，前者是模拟演示，后者是基于数据的分析
**解决**：将蒙特卡洛分析独立成页，既保持了功能的独立性，又提供了更好的用户体验
**教训**：
- 当功能的核心属性不同时，应该考虑独立成页
- 蒙特卡洛是演示算法原理，高级统计是分析业务数据
- 独立页面可以让每个功能更专注，界面更清晰

#### 2. 经典案例的教学价值 ⭐重要
**经验**：
- 蒙特卡洛方法是经典的随机模拟算法，有很多经典的教学案例
- 本次实现的三个经典案例都来自腾讯云的文章参考：
  - 计算圆周率 π：最经典的蒙特卡洛入门案例
  - 定积分计算：展示蒙特卡洛在数值计算中的应用
  - 排队问题：展示蒙特卡洛在运筹学中的应用
- 经典案例让用户可以快速理解蒙特卡洛方法的原理
- 经典案例不需要数据快照，可以直接运行

#### 3. 导航栏命名的准确性
**经验**：
- 将原来的"分析"改为"高级统计"更准确
- 因为现在分析功能已经拆分为：高级统计、蒙特卡洛、相关性
- 准确的命名可以减少用户的困惑
- 同时避免了"分析"这个过于宽泛的词

#### 4. 导航栏特殊颜色的设计规范
**经验**：
- 不同功能使用不同的背景色区分：
  - 操作指南：绿色 (#10b981)
  - 相关性：紫色 (#8b5cf6)
  - 蒙特卡洛：橙色 (#f59e0b)
- 特殊样式让用户一眼就能找到重要功能
- 不同功能用不同颜色，视觉上更清晰

#### 5. 代码清理的彻底性
**经验**：
- 从AdvancedStats.jsx中完全移除了所有蒙特卡洛相关代码：
  - 移除了蒙特卡洛的状态变量
  - 移除了蒙特卡洛的标签页
  - 移除了蒙特卡洛的UI代码
  - 移除了蒙特卡洛的结果展示代码
  - 移除了getMonteCarloChartOption函数
- 代码清理要彻底，不要留下死代码
- 彻底清理可以保持代码库的整洁

#### 6. 参考文章的有效利用
**经验**：
- 用户提供的参考文章：https://cloud.tencent.com/developer/article/1971582
- 参考文章提供了三个经典的蒙特卡洛案例
- 按参考文章实现，确保功能符合用户期望
- 参考文章是需求的重要补充

#### 7. ACP流程的持续执行 ⭐重要
**经验**：
- 本次迭代严格按照ACP流程执行：
  1. 架构师：更新需求分析和架构设计
  2. 项目经理：更新开发计划
  3. 开发人员：进行开发
  4. 代码审查人员：审查代码
  5. ACP专家：总结经验教训
- 流程是质量的保障，每个环节都不能少
- 即使用户需求简单，也要按流程执行

### 改进建议（补充）

88. **蒙特卡洛改进**：完成自定义模拟功能
89. **蒙特卡洛改进**：支持更多经典案例（如期权定价、粒子滤波等）
90. **用户体验改进**：为每个经典案例添加原理说明
91. **可视化改进**：为排队问题添加更多可视化（如等待时间趋势图）
92. **性能改进**：大模拟次数时使用Web Worker避免UI阻塞
93. **历史记录改进**：保存蒙特卡洛模拟历史，方便重复查看
94. **参数预设改进**：为每个经典案例提供参数预设
95. **结果导出改进**：支持将蒙特卡洛模拟结果导出为CSV

---

## 迭代 3.1 经验总结（便携版优化与配置系统）

### 本次迭代完成的功能
1. ✅ 创建配置文件示例（config.example.ini）
2. ✅ 创建配置读取脚本（load-config.bat）
3. ✅ 修改后端启动脚本支持配置系统
4. ✅ 修改前端启动脚本支持配置系统
5. ✅ 修改前端API地址为动态获取
6. ✅ 创建更新便携版前端脚本（update-portable.bat）
7. ✅ 更新README.md便携版说明
8. ✅ GitHub仓库更新
9. ✅ 局域网测试验证成功

### 经验教训

#### 1. 便携版部署的核心挑战 ⭐重要
**问题**：用户需要在没有安装Python和Node.js的机器上运行程序
**解决**：创建完整的便携版，包含预安装的Python和Node.js运行时
**教训**：
- 便携版需要将所有依赖打包，包括Python和Node.js运行时
- 不能假设目标机器上有任何开发环境
- 需要考虑路径的灵活性，因为运行位置可能不同

#### 2. 配置文件系统设计的要点
**经验**：
- 使用INI格式配置文件，简单易读
- 所有配置项都有默认值，与当前成功配置一致
- 注释说明每个配置项的用途
- 配置文件使用示例文件（config.example.ini）避免误修改

#### 3. 批处理脚本的路径处理
**经验**：
- 使用`%~dp0`获取脚本所在目录，实现相对路径
- 使用`setlocal enabledelayedexpansion`处理变量延迟
- 配置文件使用`endlocal`将变量传递给调用者
- 注意批处理变量赋值的特殊性

#### 4. 前端API地址的动态获取
**问题**：便携版界面显示空白，原因是前端API地址不正确
**原因**：之前使用相对路径`/api`，在serve模式下无法代理到后端
**解决**：使用`window.location.protocol + '//' + window.location.hostname + ':8000'`动态获取
**教训**：
- 前端API地址不能硬编码，要考虑不同部署环境
- 使用window.location可以自动获取当前主机信息
- 但端口号仍然硬编码，需要进一步优化

#### 5. 便携版打包的完整性
**经验**：
- 需要包含Python运行时（python.exe和必要文件）
- 需要包含Node.js运行时
- 需要包含Python依赖库（site-packages）
- 需要包含npm全局模块（serve等）
- 需要包含配置文件示例
- 需要包含启动脚本

#### 6. 局域网部署的验证
**经验**：
- 后端需要绑定到`0.0.0.0`才能被其他机器访问
- 前端serve需要监听所有网络接口
- 防火墙可能需要开放端口
- 使用`COMPUTERNAME`获取主机名在局域网可能不可靠

#### 7. GitHub发布的注意事项
**经验**：
- 便携版输出目录应该排除在版本控制外（.gitignore）
- 提交信息要清晰描述本次更新的内容
- 可以创建临时的批处理脚本简化Git操作

### 改进建议（补充）

96. **API配置改进**：前端API端口也应从配置文件读取，而非硬编码
97. **自动化改进**：创建一键打包脚本，自动化整个便携版生成过程
98. **路径检测改进**：启动时检测运行时路径是否存在，给出友好提示
99. **错误处理改进**：配置文件格式错误时给出明确错误信息
100. **文档改进**：创建详细的便携版使用说明文档

### 本次迭代完成的功能
1. ✅ 将相关性分析从高级统计中移出，创建独立页面
2. ✅ 支持选择多个数据快照
3. ✅ 支持从每个快照选择多个数值型字段
4. ✅ 支持3种相关系数类型（皮尔逊、斯皮尔曼、肯德尔）
5. ✅ 展示相关系数热力图
6. ✅ 展示高相关变量对列表（|r| &gt; 0.7）
7. ✅ 展示相关系数矩阵表格

### 经验教训

#### 1. 功能模块化的重要性 ⭐重要
**问题**：相关性分析与高级统计的其他功能（统计描述、分布拟合、回归分析、蒙特卡洛）本质不同，前者是跨多数据流字段分析，后者是单快照内分析
**解决**：将相关性分析独立成页，既保持了功能的独立性，又提供了更好的用户体验
**教训**：
- 当功能的使用场景和操作流程有本质区别时，应该考虑独立成页
- 不要强行把所有功能都塞在一个页面里
- 独立页面可以提供更专注的操作体验

#### 2. 多数据流字段合并的实现要点
**经验**：
- 使用字典收集所有字段数据，key使用"快照名-字段名"避免重名
- 使用pandas的DataFrame将所有字段合并成一个宽表
- 使用dropna(how='all')删除全部为空的行，保留有至少一个有效值的行
- 计算相关系数时，pandas会自动处理缺失值（pairwise方式）

#### 3. 高相关对识别的实用价值
**经验**：
- 自动识别|r| &gt; 0.7的高相关对，让用户快速发现强关联
- 区分强正相关和强负相关，用不同颜色标识
- 高亮显示高相关对，提升信息获取效率

#### 4. 导航栏的特殊样式设计
**经验**：
- 相关性分析按钮使用紫色背景（#8b5cf6），与其他导航项区分开
- 特殊样式让用户一眼就能找到相关性分析入口
- 与操作指南的绿色样式形成对比，不同功能用不同颜色区分

#### 5. 字段选择的交互设计
**经验**：
- 先选择快照，再从该快照选择字段，层级清晰
- 已选字段按快照分组显示，便于管理
- 每个字段显示所属快照名，避免混淆
- 实时显示已选字段数量，提示需要至少2个字段

#### 6. ACP流程的持续执行 ⭐重要
**经验**：
- 即使用户只提了一个小需求（把相关性分析移出来），也要严格按照ACP流程执行
- 本次迭代严格执行了：
  1. 架构师：更新需求分析和架构设计
  2. 项目经理：更新开发计划
  3. 开发人员：进行开发
  4. 代码审查人员：审查代码
  5. ACP专家：总结经验教训
- 流程是质量的保障，每个环节都不能少
- 用户反馈"挺好，我感觉我们越来越默契了"说明流程执行的价值

### 改进建议（补充）

76. **相关性分析改进**：支持散点图矩阵可视化，更直观展示变量间关系
77. **相关性分析改进**：支持偏相关分析，控制其他变量的影响
78. **相关性分析改进**：支持显著性检验，显示P值
79. **用户体验改进**：相关性分析页面添加"使用说明"区域
80. **功能整合改进**：考虑在相关性分析结果中提供快速跳转到回归分析的功能
81. **数据导出改进**：支持将相关系数矩阵导出为CSV或Excel

---

## 迭代 2.11 经验总结（相关性探索功能）

### 本次迭代完成的功能
1. ✅ 相关性分析中增加筛选高相关性字段功能（可配置阈值）
2. ✅ 相关性分析后面增加相关性探索标签，两者可以切换
3. ✅ 保留现在的作为相关性分析，新增相关性探索
4. ✅ 相关性探索可以选择多个数据流的多个字段，两两组成一组进行相关性分析
5. ✅ 将相关性强的几组数据提取出来，按相关系数排序
6. ✅ 相关性的判据可以客户设置约束，默认相关性分析为0.7，相关性探索为0.8

### 经验教训

#### 1. 标签页设计的重要性 ⭐重要
**问题**：用户需要两种不同的相关性分析功能：
- 相关性分析：展示完整的相关系数矩阵和热力图
- 相关性探索：只关注高相关对，按相关系数排序
**解决**：使用标签页将两者分开，保持同一界面下的功能切换
**教训**：
- 当功能相似但关注点不同时，标签页是很好的选择
- 标签页可以共享左侧的选择区域，减少重复代码
- 不同标签页可以有独立的默认参数（如阈值）

#### 2. 可配置阈值的设计要点
**经验**：
- 不同的使用场景需要不同的阈值：
  - 相关性分析：阈值0.7，找到较强的相关
  - 相关性探索：阈值0.8，只找最强的相关
- 让用户可以自由调整阈值，适应不同的需求
- 在界面上明确显示当前阈值和默认值

#### 3. 相关性探索的排序设计
**经验**：
- 按相关系数绝对值从高到低排序，让用户一眼看到最强的关联
- 展示统计信息：总对数、高相关对数，让用户了解整体情况
- 高相关对的表格设计要清晰，包含字段所属快照名

#### 4. 前端状态管理的清晰性
**经验**：
- 使用`activeTab`状态变量控制当前显示的标签页
- 两个标签页使用独立的结果状态：`correlationResult` vs `exploreResult`
- 两个标签页使用独立的阈值状态：`correlationThresholdForAnalysis` vs `correlationThresholdForExplore`
- 切换标签页时保留各自的状态，提升用户体验

#### 5. 后端API的复用和扩展
**经验**：
- 相关性分析和相关性探索共享相同的数据收集和合并逻辑
- 但返回不同的结果格式：
  - 相关性分析：返回完整矩阵、热力图数据、高相关对列表
  - 相关性探索：返回高相关对排序列表、统计信息
- 使用两个独立的API端点，职责清晰

#### 6. ACP流程的持续执行 ⭐重要
**经验**：
- 即使是小功能迭代，也要严格按照ACP流程执行
- 本次迭代严格执行了：
  1. 架构师：更新需求分析和架构设计
  2. 项目经理：更新开发计划
  3. 开发人员：进行开发
  4. 代码审查人员：审查代码
  5. ACP专家：总结经验教训
- 流程是质量的保障，每个环节都不能少
- 用户需求明确后，快速响应并完成

### 改进建议（补充）

82. **相关性探索改进**：支持查看任意两个字段的散点图
83. **相关性探索改进**：支持保存高相关对结果
84. **用户体验改进**：相关性探索页面添加"使用说明"区域
85. **性能优化改进**：字段数量多时可以分批计算
86. **历史记录改进**：保存相关性分析历史，方便重复查看
87. **阈值预设改进**：提供常用阈值预设选项（0.5、0.7、0.8、0.9）

---

## 迭代 2.12 经验总结（蒙特卡洛分析独立成页）

### 本次迭代完成的功能
1. ✅ 将蒙特卡洛分析从高级统计中移出，创建独立页面
2. ✅ 蒙特卡洛分析页面添加标签页切换（经典案例/自定义模拟）
3. ✅ 经典案例1：计算圆周率 π（蒙特卡洛方法）
4. ✅ 经典案例2：定积分计算（蒙特卡洛方法）
5. ✅ 经典案例3：排队问题模拟
6. ✅ 后端API新增三个经典蒙特卡洛案例端点
7. ✅ 导航栏添加蒙特卡洛入口（橙色背景）
8. ✅ 将"分析"导航项重命名为"高级统计"
9. ✅ 从AdvancedStats.jsx中完全移除蒙特卡洛相关代码

### 经验教训

#### 1. 功能模块化的持续重要性 ⭐重要
**问题**：蒙特卡洛分析与高级统计的其他功能（统计描述、分布拟合、回归分析）本质不同，前者是模拟演示，后者是基于数据的分析
**解决**：将蒙特卡洛分析独立成页，既保持了功能的独立性，又提供了更好的用户体验
**教训**：
- 当功能的核心属性不同时，应该考虑独立成页
- 蒙特卡洛是演示算法原理，高级统计是分析业务数据
- 独立页面可以让每个功能更专注，界面更清晰

#### 2. 经典案例的教学价值 ⭐重要
**经验**：
- 蒙特卡洛方法是经典的随机模拟算法，有很多经典的教学案例
- 本次实现的三个经典案例都来自腾讯云的文章参考：
  - 计算圆周率 π：最经典的蒙特卡洛入门案例
  - 定积分计算：展示蒙特卡洛在数值计算中的应用
  - 排队问题：展示蒙特卡洛在运筹学中的应用
- 经典案例让用户可以快速理解蒙特卡洛方法的原理
- 经典案例不需要数据快照，可以直接运行

#### 3. 导航栏命名的准确性
**经验**：
- 将原来的"分析"改为"高级统计"更准确
- 因为现在分析功能已经拆分为：高级统计、蒙特卡洛、相关性
- 准确的命名可以减少用户的困惑
- 同时避免了"分析"这个过于宽泛的词

#### 4. 导航栏特殊颜色的设计规范
**经验**：
- 不同功能使用不同的背景色区分：
  - 操作指南：绿色 (#10b981)
  - 相关性：紫色 (#8b5cf6)
  - 蒙特卡洛：橙色 (#f59e0b)
- 特殊样式让用户一眼就能找到重要功能
- 不同功能用不同颜色，视觉上更清晰

#### 5. 代码清理的彻底性
**经验**：
- 从AdvancedStats.jsx中完全移除了所有蒙特卡洛相关代码：
  - 移除了蒙特卡洛的状态变量
  - 移除了蒙特卡洛的标签页
  - 移除了蒙特卡洛的UI代码
  - 移除了蒙特卡洛的结果展示代码
  - 移除了getMonteCarloChartOption函数
- 代码清理要彻底，不要留下死代码
- 彻底清理可以保持代码库的整洁

#### 6. 参考文章的有效利用
**经验**：
- 用户提供的参考文章：https://cloud.tencent.com/developer/article/1971582
- 参考文章提供了三个经典的蒙特卡洛案例
- 按参考文章实现，确保功能符合用户期望
- 参考文章是需求的重要补充

#### 7. ACP流程的持续执行 ⭐重要
**经验**：
- 本次迭代严格按照ACP流程执行：
  1. 架构师：更新需求分析和架构设计
  2. 项目经理：更新开发计划
  3. 开发人员：进行开发
  4. 代码审查人员：审查代码
  5. ACP专家：总结经验教训
- 流程是质量的保障，每个环节都不能少
- 即使用户需求简单，也要按流程执行

### 改进建议（补充）

88. **蒙特卡洛改进**：完成自定义模拟功能
89. **蒙特卡洛改进**：支持更多经典案例（如期权定价、粒子滤波等）
90. **用户体验改进**：为每个经典案例添加原理说明
91. **可视化改进**：为排队问题添加更多可视化（如等待时间趋势图）
92. **性能改进**：大模拟次数时使用Web Worker避免UI阻塞
93. **历史记录改进**：保存蒙特卡洛模拟历史，方便重复查看
94. **参数预设改进**：为每个经典案例提供参数预设
95. **结果导出改进**：支持将蒙特卡洛模拟结果导出为CSV
